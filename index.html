<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>A1 VIP Ticket Dashboard</title>

  <!-- PWA hooks -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#0b1220">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="A1VIP">
  <link rel="apple-touch-icon" href="icons/apple-touch-icon.png">

  <style>
    :root { --bg:#0b1220; --text:#e5e7eb; --border:rgba(148,163,184,.22);
            --gold:#facc15; --blue:#3b82f6; --pink:#ec4899; --red:#ef4444; --black:#000;
            --btn-color:#1e293b; --btn-color-hover:#facc15; }
    html,body{margin:0;padding:0;height:100%}
    body{font-family:Arial,Helvetica,sans-serif;background:var(--bg);color:var(--text);display:flex;flex-direction:column}

    header{
      position:sticky;top:0;z-index:1000;
      padding:10px 16px;
      padding-top:calc(env(safe-area-inset-top) + 8px);
      background:#111827;border-bottom:1px solid var(--border);
      display:flex;align-items:center;gap:12px;
    }
    header img{height:150px}
    .title{font-size:2.1rem;line-height:1.05;font-weight:900;letter-spacing:.2px}

    /* Logout button in header */
    .logout-btn{
      margin-left:auto;
      background:#ef4444;
      border:none;
      color:#fff;
      font-weight:700;
      border-radius:999px;
      padding:8px 14px;
      cursor:pointer;
      font-size:0.8rem;
      white-space:nowrap;
    }
    .logout-btn:hover{
      filter:brightness(1.1);
    }

    .search-row{margin:10px 0 4px;display:flex;flex-direction:column;gap:6px}
    .search-row input{padding:8px 10px;border-radius:999px;border:1px solid var(--border);background:#020617;color:#e5e7eb;font-size:0.85rem}
    .search-results{max-height:180px;overflow:auto;font-size:0.8rem;border-radius:10px;background:#020617;border:1px solid #111827;padding:4px 6px}
    .search-result-item{padding:4px 6px;border-radius:6px;cursor:pointer;color:#e5e7eb}
    .search-result-item:hover{background:#1f2937}
    .btn-highlight{box-shadow:0 0 0 2px #22d3ee,0 0 12px #22d3ee}

    .link-status{font-size:11px;min-height:14px;color:#9ca3af;padding:2px 16px 4px;background:transparent;opacity:.85;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}

    #installBtn{position:fixed;top:calc(env(safe-area-inset-top) + 8px);left:8px;z-index:1200;display:none;background:#16a34a;color:#fff;border:none;padding:8px 10px;border-radius:10px;font-weight:800;cursor:pointer}

    .top-tabs{padding:12px 16px 6px;background:linear-gradient(180deg,#0b1220 0%,rgba(11,18,32,.7) 100%)}
    .tabs-scroller{display:flex;gap:10px;overflow-x:auto;-webkit-overflow-scrolling:touch;scroll-snap-type:x mandatory}
    .tabs-scroller::-webkit-scrollbar{display:none}
    .tab{flex:0 0 auto;scroll-snap-align:start;border:none;padding:10px 16px;border-radius:12px;cursor:pointer;font-weight:800;color:#fff;user-select:none;box-shadow:0 0 0 1px rgba(148,163,184,.22) inset;transition:.2s}
    .tab-main{background:var(--gold);color:#000}.tab-main:hover{background:#ffe44d}
    .tab-luxury{background:var(--blue)}.tab-luxury:hover{background:#60a5fa}
    .tab-accounts{background:var(--pink)}.tab-accounts:hover{background:#f472b6}
    .tab-travel{background:var(--red)}.tab-travel:hover{background:#f87171}
    .tab-social{background:#000}.tab-social:hover{background:#1f2937}
    .tab-admin{background:#fff;color:#000}.tab-admin:hover{background:#e5e7eb}

    main{flex:1;overflow:auto;-webkit-overflow-scrolling:touch;padding:16px 16px 28px}
    .section{margin-bottom:30px}
    h3{color:#facc15;font-size:1.3rem;margin:10px 4px 14px}

    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:16px}
    .btn{display:flex;align-items:center;justify-content:center;gap:10px;padding:16px;border-radius:16px;background:var(--btn-color,#1e293b);color:#fff;font-weight:800;border:1px solid var(--border);transition:.25s;text-align:center}
    .btn:hover{background:var(--btn-color-hover,#facc15);color:#000;box-shadow:0 0 15px var(--btn-color-hover,#facc15)}

    details{background:#0f172a;border:1px solid var(--border);border-radius:12px;margin:10px 0}
    summary{cursor:pointer;font-weight:800;padding:10px 14px;color:#e5e7eb}
    details .inner{padding:12px}
    .note{color:#9ca3af;font-size:.9rem}

    .upload-card{background:#0f172a;border:1px solid var(--border);border-radius:14px;padding:16px;display:grid;gap:14px}
    .upload-grid{display:grid;grid-template-columns:1fr;gap:14px}
    .upload-grid label{font-weight:700}
    .upload-grid textarea{width:100%;min-height:120px;border-radius:10px;border:1px solid var(--border);background:#111827;color:#e5e7eb;padding:10px}
    .upload-grid input[type=file]{border:1px dashed var(--border);padding:12px;border-radius:10px;background:#0b1220;color:#e5e7eb}
    .targets{display:flex;flex-wrap:wrap;gap:10px}
    .chip{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--border);padding:8px 12px;border-radius:999px;background:#111827}
    .upload-actions{display:flex;flex-wrap:wrap;gap:12px}
    .cta{border:none;border-radius:10px;padding:10px 14px;font-weight:800;cursor:pointer}
    .cta-primary{background:#22d3ee;color:#0b1220}.cta-primary:hover{filter:brightness(1.1)}
    .cta-secondary{background:#facc15;color:#0b1220}.cta-secondary:hover{filter:brightness(1.05)}

    .manager-row{display:flex;flex-wrap:wrap;gap:12px;margin-top:8px}
    .btn-add{background:#16a34a}.btn-add:hover{filter:brightness(1.05)}
    .btn-remove{background:#ef4444}.btn-remove:hover{filter:brightness(1.05)}
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;z-index:2000}
    .modal-card{width:min(560px,92vw);background:#0f172a;border:1px solid var(--border);border-radius:16px;padding:16px;box-shadow:0 10px 30px rgba(0,0,0,.5)}
    .modal h4{margin:0 0 12px;color:#facc15}
    .form-grid{display:grid;gap:12px}
    .form-grid label{font-weight:700}
    .form-grid select,.form-grid input{width:100%;padding:10px;border-radius:10px;border:1px solid var(--border);background:#111827;color:#e5e7eb}
    .modal-actions{display:flex;gap:10px;justify-content:flex-end;margin-top:12px}
    .ghost{background:transparent;border:1px solid var(--border);color:#e5e7eb}
  
    .quick-link-bar{display:flex;gap:8px;align-items:center;padding:4px 16px 8px;}
    .quick-link-bar input{flex:1;padding:8px 10px;border-radius:999px;border:1px solid var(--border);background:#020617;color:#e5e7eb;font-size:0.85rem;}
    .btn-quick-go{padding:8px 12px;font-size:0.8rem;}
    .btn-quick-add{padding:8px 12px;font-size:0.8rem;background:#22c55e;border-color:#22c55e;}
    .btn-quick-add:hover{background:#4ade80;color:#022c22;box-shadow:0 0 10px rgba(34,197,94,.8);}
    .btn[data-quick="1"]{background:#22c55e;border-color:#22c55e;}
    .btn[data-quick="1"]:hover{background:#4ade80;color:#022c22;box-shadow:0 0 12px rgba(34,197,94,.9);}

    /* ===== Login overlay ===== */
    .login-screen{
      position:fixed;
      inset:0;
      background:#020617;
      display:none;
      align-items:center;
      justify-content:center;
      z-index:5000;
    }
    .login-card{
      width:min(360px,90vw);
      background:#0f172a;
      border:1px solid var(--border);
      border-radius:16px;
      padding:20px;
      box-shadow:0 18px 40px rgba(0,0,0,.8);
      display:grid;
      gap:12px;
    }
    .login-card h2{
      margin:0 0 4px;
      font-size:1.4rem;
      color:#facc15;
      text-align:center;
    }
    .login-card p{
      margin:0 0 6px;
      font-size:0.8rem;
      color:#9ca3af;
      text-align:center;
    }
    .login-card label{
      font-size:0.85rem;
      font-weight:700;
      display:grid;
      gap:4px;
      color:#e5e7eb;
    }
    .login-card input{
      padding:10px;
      border-radius:10px;
      border:1px solid var(--border);
      background:#020617;
      color:#e5e7eb;
    }
    .login-actions{
      display:flex;
      justify-content:center;
      margin-top:6px;
    }
    .login-btn{
      border:none;
      border-radius:999px;
      padding:10px 20px;
      font-weight:800;
      cursor:pointer;
      background:#facc15;
      color:#000;
    }
    .login-btn:hover{
      filter:brightness(1.05);
    }
    .login-error{
      min-height:16px;
      font-size:0.8rem;
      color:#f97373;
      text-align:center;
      margin-top:4px;
    }

  </style>
</head>
<body>

  <!-- Login Screen -->
  <div id="loginScreen" class="login-screen" style="display:none;">
    <div class="login-card">
      <h2>A1 VIP Login</h2>
      <p>Enter your credentials to access the dashboard.</p>
      <label>
        Username
        <input id="loginUser" type="text" autocomplete="username" placeholder="Username">
      </label>
      <label>
        Password
        <input id="loginPass" type="password" autocomplete="current-password" placeholder="Password">
      </label>
      <div class="login-actions">
        <button class="login-btn" onclick="handleLogin()">Login</button>
      </div>
      <div id="loginError" class="login-error"></div>
    </div>
  </div>

  <header>
    <img src="A1VIP_LOGO_VERT_for _Black_backgrounds.png" alt="Logo">
    <div class="title">A1 VIP<br/>Ticket<br/>Dashboard</div>
    <!-- Logout button -->
    <button class="logout-btn" onclick="logout()">Logout</button>
  </header>

  <div id="linkStatus" class="link-status"></div>

  <div class="quick-link-bar">
    <input id="quickLinkInput" type="url" placeholder="Paste or type a link (https://...)" />
    <button class="btn btn-quick-go" onclick="openQuickLink()">Go</button>
    <button class="btn btn-quick-add" onclick="addQuickLinkButton()">Add to Main</button>
  </div>

  <nav class="top-tabs">
    <div class="tabs-scroller">
      <button class="tab tab-main" onclick="showSection('main')">Main Links</button>
      <button class="tab tab-luxury" onclick="showSection('luxury')">Luxury Suites</button>
      <button class="tab tab-accounts" onclick="showSection('accounts')">Ticket Accounts</button>
      <button class="tab tab-travel" onclick="showSection('travel')">Travel</button>
      <button class="tab tab-social" onclick="showSection('social')">Social</button>
      <button class="tab tab-admin" onclick="showSection('admin')">Admin</button>
    </div>
  </nav>

  <main>
    <div id="main" class="section">
      <h3>Main Links</h3>
      <div class="grid" data-section="main"></div>
    </div>

    <div id="luxury" class="section" style="display:none;">
      <h3>Luxury Suites</h3>
      <div class="grid" data-section="luxury"></div>
    </div>

    <div id="accounts" class="section" style="display:none;">
      <h3>Ticket Accounts</h3>
      <div class="grid" data-section="accounts"></div>
    </div>

    <div id="travel" class="section" style="display:none;">
      <h3>Travel</h3>
      <div class="grid" data-section="travel"></div>

      <details>
        <summary>Private Jet</summary>
        <div class="inner">
          <div class="grid" data-section="privatejet"></div>
        </div>
      </details>

      <details>
        <summary>Luxury Homes</summary>
        <div class="inner">
          <div class="grid" data-section="luxhomes"></div>
        </div>
      </details>


       <details>
       <summary>Yachts</summary>
       <div class="inner">
         <div class="grid" data-section="yachts"></div>
     </div>
     </details>
    </div>

    <div id="social" class="section" style="display:none;">
      <h3>Social</h3>
      <div class="grid" data-section="social"></div>
    </div>

    <div id="admin" class="section" style="display:none;">
      <h3>Admin</h3>
      <div class="search-row">
        <input id="linkSearch" type="text" placeholder="Search buttons..." oninput="searchLinks()" />
        <div id="searchResults" class="search-results"></div>
      </div>
      <div class="grid">
        <button class="btn" onclick="showSection('domains')">A1 Domains & Emails</button>
        <button class="btn" onclick="openPopup('https://a1vipevents.com/')">A1VIP</button>
        <button class="btn" onclick="openPopup('https://a1vipevents.com/wp-login.php?redirect_to=https%3A%2F%2Fa1vipevents.com%2Fwp-admin%2F&reauth=1')">BackEnd</button>
        <button class="btn" onclick="showSection('upload')">UPLOAD</button>
        <button class="btn" onclick="showSection('buttonManager')">Button Manager</button>
        <button class="btn" style="display:none;" data-system-btn="1" onclick="showSection('system')">SYSTEM</button>
      </div>
    </div>

    <div id="system" class="section" style="display:none;">
      <h3>SYSTEM Tools</h3>
      <div class="grid">
        <button class="btn btn-remove" onclick="resetDashboard()">Reset Dashboard (Factory)</button>
        <button class="btn" onclick="toggleTheme()">Toggle Button Theme</button>
        <button class="btn" onclick="exportLayout()">Backup / Export Layout</button>
      </div>

      <div style="margin-top:10px;font-size:0.8rem;">
        <label for="themeColor">
          Button Color:
          <input id="themeColor" type="color" onchange="setThemeColor(this.value)" style="margin-left:6px;vertical-align:middle;">
        </label>
      </div>

      <!-- Login Settings tool -->
      <div class="upload-card" style="margin-top:18px;">
        <h4 style="margin:0 0 8px;color:#facc15;">Login Settings</h4>
        <div class="form-grid">
          <label>Current Password
            <input id="authCurrentPass" type="password" autocomplete="current-password">
          </label>
          <label>New Username
            <input id="authNewUser" type="text" autocomplete="username">
          </label>
          <label>New Password
            <input id="authNewPass" type="password" autocomplete="new-password">
          </label>
        </div>
        <div class="modal-actions" style="justify-content:flex-start;margin-top:10px;">
          <button class="cta cta-primary" onclick="updateCredentials()">Update Login</button>
          <button class="cta ghost" onclick="resetCredentialsToDefault()">Reset to Default</button>
        </div>
        <div id="authUpdateMsg" class="note" style="margin-top:6px;"></div>
        <div class="note" style="margin-top:4px;">
          Changes apply only to this browser/device.
        </div>
      </div>

      <p style="font-size:0.8rem;color:#9ca3af;margin-top:8px;">
        Desktop: hold Alt while viewing Admin. Mobile: long-press the Admin tab to show/hide SYSTEM.
      </p>
    </div>

    <div id="domains" class="section" style="display:none;">
      <h3>A1 Domains & Emails</h3>
      <div class="grid" data-section="domains"></div>
    </div>

    <section id="upload" class="section" style="display:none;">
      <h3>UPLOAD</h3>
      <div class="upload-card">
        <div class="upload-grid">
          <div>
            <label for="uploadDesc">Post Description</label>
            <textarea id="uploadDesc" placeholder="Write the caption / description you want on your posts..."></textarea>
            <div class="note">We‚Äôll copy this to your clipboard so you can paste it on each site.</div>
          </div>
          <div>
            <label for="uploadFile">Video File</label>
            <input id="uploadFile" type="file" accept="video/*" />
            <div class="note">A single HTML file can‚Äôt upload to multiple sites without APIs/OAuth. The buttons below open each site‚Äôs upload page.</div>
          </div>
          <div>
            <label>Targets</label>
            <div class="targets">
              <label class="chip"><input type="checkbox" id="tYouTube" checked> YouTube</label>
              <label class="chip"><input type="checkbox" id="tFacebook" checked> Facebook</label>
              <label class="chip"><input type="checkbox" id="tInstagram" checked> Instagram</label>
              <label class="chip"><input type="checkbox" id="tTikTok" checked> TikTok</label>
            </div>
          </div>
        </div>
        <div class="upload-actions">
          <button class="cta cta-secondary" onclick="copyDescription()">Copy Description</button>
          <button class="cta cta-primary" onclick="openUploadPages()">Open Upload Pages</button>
          <div class="note">If only one window opens, your browser is blocking multiple popups. Allow popups for this page or open sites one by one.</div>
        </div>
      </div>
    </section>

    <section id="buttonManager" class="section" style="display:none;">
      <h3>Button Manager</h3>
      <div class="manager-row">
        <button class="btn btn-add" onclick="openAddModal()">‚ûï Add Button</button>
        <button class="btn" style="background:#3b82f6" onclick="openMoveModal()">üîÄ Move Button</button>
        <button class="btn" onclick="openRenameModal()">‚úèÔ∏è Rename Button</button>
        <button class="btn btn-remove" onclick="openRemoveModal()">‚ûñ Remove Button</button>
      </div>
    </section>
  </main>

  <!-- Add Modal -->
  <div id="addModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="addTitle">
    <div class="modal-card">
      <h4 id="addTitle">Add a New Button</h4>
      <div class="form-grid">
        <label>Section
          <select id="addSection"></select>
        </label>
        <label>Button Label
          <input id="addLabel" type="text" placeholder="e.g., Team Store">
        </label>
        <label>Button URL
          <input id="addUrl" type="url" placeholder="https://example.com">
        </label>
      </div>
      <div class="modal-actions">
        <button class="cta ghost" onclick="closeModal('addModal')">Cancel</button>
        <button class="cta cta-primary" onclick="confirmAdd()">Add</button>
      </div>
    </div>
  </div>

  <!-- Rename Modal -->
  <div id="renameModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="renameTitle">
    <div class="modal-card">
      <h4 id="renameTitle">Rename Button</h4>
      <div class="form-grid">
        <label>Section
          <select id="renameSection" onchange="populateRenameList()"></select>
        </label>
        <label>Button to Rename
          <select id="renameButton"></select>
        </label>
        <label>New Label
          <input id="renameNewLabel" type="text" placeholder="New button label" />
        </label>
      </div>
      <div class="modal-actions">
        <button class="cta ghost" onclick="closeModal('renameModal')">Cancel</button>
        <button class="cta cta-primary" onclick="confirmRename()">Rename</button>
      </div>
    </div>
  </div>

  <!-- Remove Modal -->
  <div id="removeModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="removeTitle">
    <div class="modal-card">
      <h4 id="removeTitle">Remove a Button</h4>
      <div class="form-grid">
        <label>Section
          <select id="removeSection" onchange="populateRemoveList()"></select>
        </label>
        <label>Pick Button to Remove
          <select id="removeButton"></select>
        </label>
      </div>
      <div class="modal-actions">
        <button class="cta ghost" onclick="closeModal('removeModal')">Cancel</button>
        <button class="cta cta-secondary" onclick="confirmRemove()">Remove</button>
      </div>
    </div>
  </div>

  <!-- Move Modal -->
  <div id="moveModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="moveTitle">
    <div class="modal-card">
      <h4 id="moveTitle">Move a Button</h4>
      <div class="form-grid">
        <label>From Section
          <select id="moveFrom" onchange="populateMoveList()"></select>
        </label>
        <label>Pick Button to Move
          <select id="moveButton"></select>
        </label>
        <label>To Section
          <select id="moveTo"></select>
        </label>
      </div>
      <div class="modal-actions">
        <button class="cta ghost" onclick="closeModal('moveModal')">Cancel</button>
        <button class="cta cta-primary" onclick="confirmMove()">Move</button>
      </div>
    </div>
  </div>

  <script>
    /* ===== Config ===== */
    const CONFIG_URLS = [
      'https://raw.githubusercontent.com/paq-man23/a1vip-dashboard/main/buttons.json',
      'https://paq-man23.github.io/a1vip-dashboard/buttons.json'
    ];
    const SYNC_ENDPOINT = 'https://a1vip-sync.jviphone.workers.dev';
    const SHARED_SECRET = 'a1vip-2025-sync-9fK2sX';
    const STORAGE_KEY = 'a1vip-button-manager-v2';

    /* ===== Auth (with overrides) ===== */
    const AUTH_DEFAULT_USER = 'JAW';
    const AUTH_DEFAULT_PASS = 'Da$h25';
    const AUTH_KEY          = 'a1vip-auth-v1';
    const AUTH_OVERRIDE_KEY = 'a1vip-auth-override';

    function getAuthCreds(){
      try{
        const raw = localStorage.getItem(AUTH_OVERRIDE_KEY);
        if (raw){
          const parsed = JSON.parse(raw);
          if (parsed && parsed.user && parsed.pass){
            return { user:String(parsed.user), pass:String(parsed.pass) };
          }
        }
      }catch(e){}
      return { user:AUTH_DEFAULT_USER, pass:AUTH_DEFAULT_PASS };
    }

    function isAuthenticated(){
      try{
        const token = localStorage.getItem(AUTH_KEY);
        if (!token) return false;
        const creds = getAuthCreds();
        return token === 'ok::' + creds.user;
      }catch(e){
        return false;
      }
    }

    function showLogin(){
      const el = document.getElementById('loginScreen');
      if (el) el.style.display = 'flex';
      const uEl = document.getElementById('loginUser');
      const pEl = document.getElementById('loginPass');
      const err = document.getElementById('loginError');
      if (uEl) uEl.value = '';
      if (pEl) pEl.value = '';
      if (err) err.textContent = '';
    }
    function hideLogin(){
      const el = document.getElementById('loginScreen');
      if (el) el.style.display = 'none';
    }

    function handleLogin(){
      const uEl = document.getElementById('loginUser');
      const pEl = document.getElementById('loginPass');
      const err = document.getElementById('loginError');
      const u = (uEl?.value || '').trim();
      const p = pEl?.value || '';
      const creds = getAuthCreds();
      if (u === creds.user && p === creds.pass){
        try{ localStorage.setItem(AUTH_KEY,'ok::' + creds.user); }catch(e){}
        if (err) err.textContent = '';
        hideLogin();
      }else{
        if (err) err.textContent = 'Invalid username or password.';
        else alert('Invalid username or password.');
      }
    }

    function logout(){
      try{
        localStorage.removeItem(AUTH_KEY);
      }catch(e){}
      showLogin();
      window.scrollTo({ top:0, behavior:'smooth' });
    }

    function setAuthMessage(text, okColor){
      const msg = document.getElementById('authUpdateMsg');
      if (!msg){
        if (text) alert(text);
        return;
      }
      msg.textContent = text || '';
      msg.style.color = okColor || '#f97373';
    }

    function updateCredentials(){
      const currentPass = document.getElementById('authCurrentPass')?.value || '';
      const newUser = (document.getElementById('authNewUser')?.value || '').trim();
      const newPass = document.getElementById('authNewPass')?.value || '';
      const creds = getAuthCreds();

      if (!currentPass){
        setAuthMessage('Please enter your current password.', '#f97373');
        return;
      }
      if (currentPass !== creds.pass){
        setAuthMessage('Current password is incorrect.', '#f97373');
        return;
      }
      if (!newUser || !newPass){
        setAuthMessage('New username and password cannot be empty.', '#f97373');
        return;
      }
      if (newUser.length < 2){
        setAuthMessage('New username must be at least 2 characters.', '#f97373');
        return;
      }

      try{
        const override = { user:newUser, pass:newPass };
        localStorage.setItem(AUTH_OVERRIDE_KEY, JSON.stringify(override));
        localStorage.setItem(AUTH_KEY, 'ok::' + newUser);

        const cur = document.getElementById('authCurrentPass');
        const np  = document.getElementById('authNewPass');
        if (cur) cur.value = '';
        if (np)  np.value  = '';
        setAuthMessage('Login updated for this browser/device.', '#4ade80');
      }catch(e){
        setAuthMessage('Could not save new login: ' + e.message, '#f97373');
      }
    }

    function resetCredentialsToDefault(){
      if (!confirm('Reset login to default username/password (JAW / Da$h25) for this browser?')){
        return;
      }
      try{
        localStorage.removeItem(AUTH_OVERRIDE_KEY);
        localStorage.removeItem(AUTH_KEY);
        setAuthMessage('Login reset to default (JAW / Da$h25). You will use these next time you log in.', '#facc15');
      }catch(e){
        setAuthMessage('Could not reset: ' + e.message, '#f97373');
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      if (!isAuthenticated()){
        showLogin();
      }else{
        hideLogin();
      }
      const uEl = document.getElementById('loginUser');
      const pEl = document.getElementById('loginPass');
      [uEl,pEl].forEach(el=>{
        if (!el) return;
        el.addEventListener('keydown', (e)=>{
          if (e.key === 'Enter') handleLogin();
        });
      });
    });

    /* ===== Seed (links) ===== */
    const SEED = {
      main: [
        ["Audience Rewards","https://www.audiencerewards.com/"],
        ["AXS","https://www.axs.com/"],
        ["Braintree","https://www.braintreegateway.com/login"],
        ["Broadway Box Discounts","https://www.broadwaybox.com/"],
        ["Broadwaydirect","https://tickets.broadwaydirect.com/shop/account/login?returnUrl=https://tickets.broadwaydirect.com/Account/Orders"],
        ["Charity buzz","https://www.charitybuzz.com/"],
        ["Chase Gets You In Lounge","https://chasegetsyoucloser.com/login/?msg=200"],
        ["ChatGPT","https://chatgpt.com/"],
        ["Clover Go A1","https://www.clover.com/login?webRedirectUrl=%2Fdashboard"],
        ["Core Ticketevolution","https://core.ticketevolution.com"],
        ["FedEx","https://www.fedex.com/secure-login/en-us/#/credentials"],
        ["Gametime Portal","https://portal.gametime.co/login"],
        ["Mailchimp","https://login.mailchimp.com/login/unified-login"],
        ["M&T Rewards","https://rewards.mtb.com/welcome.htm"],
        ["MLB.com","https://www.mlb.com/login?redirectUri=/apps/ballpark"],
        ["MyTicketmaster","https://www.ticketmaster.com"],
        ["Pollstar","https://www.pollstar.com/login"],
        ["Presale","https://www.presalepasswordinfo.com/members/checkuser.php"],
        ["Quint","https://quint.co/"],
        ["Rate Your Seats","https://www.rateyourseats.com"],
        ["Ryder Cup","https://onlocationexp.com/golf/ryder-cup-tickets"],
        ["SeatGeek","https://seatgeek.com/"],
        ["Seatgeek Portal","https://sellers.seatgeek.com/orders?status=all&selectedTab=all"],
        ["Skybox","https://skybox.vividseats.com/inventory?groupBy=event&sortedBy=event_date&sortDir=asc&limit=100&pageNumber=1&sortedByB=quantity&sortDirB=asc"],
        ["StubHub","https://www.stubhub.com/"],
        ["TAO Suite","https://www.suitesixteenlounge.com/"],
        ["TicketFlipping","https://ticketflipping.com/ticketflipping-toolbox/"],
        ["Ticket Utils","https://app.ticketutils.com/POS/DashBoard"],
        ["Ticketnetwork POS NEXT","https://posnext.ticketnetwork.com/#inventory"],
        ["Trade Desk","https://tradedesk.ticketmaster.com"],
        ["Victory Live","https://www.victorylive.com"],
        ["Vista Print","https://www.vistaprint.com/my-account/design/projects?xnav=accountMenu"]
      ],
      luxury: [
        ["Suite Experience","https://www.suiteexperiencegroup.com/"],
        ["Suite Hop","https://suitehop.com/"],
        ["MSG Premium Hospitality","https://www.msg.com/madison-square-garden/luxury-suites"],
        ["LSA Suites","https://lsaus.com/"],
        ["The Sphere Suites","https://www.thesphere.com/premium-suites"],
        ["Access Sports","https://accessvipsports.com/about-us/"]
      ],
      accounts: [
        ["Dolphins","https://am.ticketmaster.com/dolphins/my-events"],
        ["NY Islanders","https://am.ticketmaster.com/newyorkislanders/my-events#/17998"],
        ["Predators","https://am.ticketmaster.com/predators/my-events"],
        ["Vanderbilt","https://vucommodores.evenue.net/signin"],
        ["Vols","https://am.ticketmaster.com/allvols/my-events"],
        ["Yankees","https://am.ticketmaster.com/nyyreg/my-events"]
      ],
      travel: [
        ["ARCCORP","https://www2.arccorp.com/#"],
        ["Delta","https://www.delta.com/"],
        ["Expedia","https://www.expedia.com/Hotels?v=b"],
        ["EZ-PASS","https://www.e-zpassny.com/vector/account/transactions/transactionlist.do"],
        ["Jetset","https://jetsetjansen.com/versace-mansion-miami/"],
        ["JSX","https://www.jsx.com/home/search"],
        ["Universal","https://www.universalpartnercommunity.com/s/login/SelfRegister?language=en_US"],
        ["Yachts","https://www.burgessyachts.com/en/charter-a-yacht/yachts-for-charter/aquila-00005340"]
      ],
      privatejet: [
        ["Fly XO","https://flyxo.com/"],
        ["Flyte","https://www.flyte.travel/rebrand"],
        ["Private Jet Contracts","javascript:alert('Add contract link URL and I\\'ll wire this up.')"],
        ["Private Jet Fly USA","https://flyusa.com/book-private-flights/"],
        ["Wheels Up","https://wheelsup.com/"]
      ],
      luxhomes: [
        ["Airbnb","https://www.airbnb.com/"],
        ["VRBO","https://www.vrbo.com/"]
      ],
      yachts: [
        ["Barton Yachts","https://www.bartonyachts.com/"]
      ],
      social: [
        ["Facebook","https://www.facebook.com/"],
        ["Instagram","https://www.instagram.com/"],
        ["LinkedIn","https://www.linkedin.com/"],
        ["Mailchimp","https://mailchimp.com/"],
        ["Tiktok","https://tiktok.com/"],
        ["YouTube","https://www.youtube.com/"]
      ],
      domains: [
        ["A1 Timesheets","https://1drv.ms/x/c/f3acac4cab808f86/EQsA5-xNQvBApOR3XhRkD1EBNC3MT3eW0wlrza-6wpYNPQ?e=fbawZI"],
        ["Domain Pal","https://domainpal.com/"],
        ["GoDaddy","https://www.godaddy.com/"]
      ]
    };

    function seedDOM(){
      Object.entries(SEED).forEach(([sec, items])=>{
        const grid = sectionGrid(sec);
        if(!grid) return;
        items.forEach(([label,url])=> grid.appendChild(createBtn(label,url,false)));
      });
    }

    function searchLinks(){
      const input = document.getElementById('linkSearch');
      const resultsBox = document.getElementById('searchResults');
      if (!input || !resultsBox) return;
      const q = (input.value || '').trim().toLowerCase();
      resultsBox.innerHTML = '';
      if (!q) return;

      const matches = [];
      document.querySelectorAll('.grid[data-section] .btn').forEach(btn => {
        const label = (btn.textContent || '').trim();
        if (!label.toLowerCase().includes(q)) return;
        const grid = btn.closest('.grid');
        if (!grid) return;
        const secId = grid.getAttribute('data-section');
        matches.push({ label, secId, btn });
      });

      matches.slice(0,50).forEach(m => {
        const div = document.createElement('div');
        const secMeta = (window.manageableSections || []).find(s => s.id === m.secId);
        div.className = 'search-result-item';
        div.textContent = (secMeta ? secMeta.label : m.secId) + ': ' + m.label;
        div.onclick = () => {
          const topSection = (m.secId === 'privatejet' || m.secId === 'luxhomes') ? 'travel' : m.secId;
          showSection(topSection);
          if (topSection === 'travel'){
            document.querySelectorAll('#travel details').forEach(d => d.open = true);
          }
          setTimeout(() => {
            m.btn.scrollIntoView({ behavior:'smooth', block:'center' });
            m.btn.classList.add('btn-highlight');
            setTimeout(() => m.btn.classList.remove('btn-highlight'), 1200);
          }, 40);
        };
        resultsBox.appendChild(div);
      });
    }

    function resetDashboard(){
      if (!confirm('This will erase all custom buttons, login overrides, and sync a factory reset. Continue?')) return;
      const empty = { added:{}, removed:{} };
      try{
        saveState(empty);
        localStorage.removeItem('a1vip-auth-override');
        localStorage.removeItem(AUTH_KEY);
      }catch(e){ console.warn('saveState during reset failed', e); }
      (async () => {
        try{
          await syncRemote(empty);
        }catch(e){
          console.warn('syncRemote during reset failed', e);
        }finally{
          localStorage.removeItem('a1vip-button-manager-v2');
          location.reload();
        }
      })();
    }

    function toggleTheme(){
      const rand = '#' + Math.floor(Math.random()*16777215).toString(16).padStart(6,'0');
      setThemeColor(rand);
      try{ localStorage.setItem('a1vip-theme-color', rand); }catch(e){}
      const picker = document.getElementById('themeColor');
      if (picker) picker.value = rand;
    }

    async function exportLayout(){
      try{
        const local = loadState();
        const remote = await fetchRemoteConfig();
        const merged = mergeStates(local, remote);
        const blob = new Blob([JSON.stringify(merged, null, 2)], { type:'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        const ts = new Date().toISOString().slice(0,19).replace(/[:T]/g,'-');
        a.href = url;
        a.download = 'a1vip-buttons-backup-' + ts + '.json';
        document.body.appendChild(a);
        a.click();
        a.remove();
        setTimeout(() => URL.revokeObjectURL(url), 2000);
      }catch(e){
        alert('Export failed: ' + e.message);
      }
    }

    function setThemeColor(hex){
      if (!hex) return;
      document.documentElement.style.setProperty('--btn-color', hex);
      const hover = lightenHex(hex, 0.12);
      document.documentElement.style.setProperty('--btn-color-hover', hover);
      try{
        localStorage.setItem('a1vip-theme-color', hex);
      }catch(e){}
    }

    function lightenHex(hex, amt){
      try{
        let c = hex.replace('#','');
        if (c.length === 3){
          c = c.split('').map(ch => ch + ch).join('');
        }
        let num = parseInt(c,16);
        let r = (num >> 16) & 255;
        let g = (num >> 8) & 255;
        let b = num & 255;
        const f = (v) => Math.min(255, Math.max(0, Math.round(v + (255 - v) * amt)));
        r = f(r); g = f(g); b = f(b);
        const out = (r << 16) | (g << 8) | b;
        return '#' + out.toString(16).padStart(6,'0');
      }catch(e){
        return hex;
      }
    }

    /* ===== SYSTEM visibility: desktop Alt + mobile long-press ===== */
    let systemAltDown = false;
    let systemUnlocked = false; // toggled by long-press on Admin tab (mobile)

    function isTouchDevice(){
      return (
        'ontouchstart' in window ||
        navigator.maxTouchPoints > 0 ||
        navigator.msMaxTouchPoints > 0
      );
    }

    function updateSystemButtonVisibility(currentSectionId){
      const btn = document.querySelector('#admin .grid [data-system-btn]');
      if (!btn) return;

      const adminSec = document.getElementById('admin');
      const isAdminVisible = currentSectionId
        ? currentSectionId === 'admin'
        : (adminSec && adminSec.style.display !== 'none');

      const shouldShow = isAdminVisible && (systemAltDown || systemUnlocked);
      btn.style.display = shouldShow ? 'inline-flex' : 'none';
    }

    // Desktop: Alt key holds
    document.addEventListener('keydown', (e) => {
      if (e.altKey || e.key === 'Alt'){
        systemAltDown = true;
        updateSystemButtonVisibility();
      }
    });
    document.addEventListener('keyup', (e) => {
      if (!e.altKey || e.key === 'Alt'){
        systemAltDown = false;
        updateSystemButtonVisibility();
      }
    });

    // Mobile: long-press Admin tab to toggle SYSTEM
    document.addEventListener('DOMContentLoaded', () => {
      if (!isTouchDevice()) return; // only on touch devices

      const adminTab = document.querySelector('.tab-admin');
      if (!adminTab) return;

      let pressTimer = null;

      const startPress = (e) => {
        if (!e.touches || e.touches.length !== 1) return;
        pressTimer = setTimeout(() => {
          systemUnlocked = !systemUnlocked; // toggle on/off
          updateSystemButtonVisibility('admin');
        }, 900); // ~0.9s long-press
      };

      const cancelPress = () => {
        if (pressTimer) {
          clearTimeout(pressTimer);
          pressTimer = null;
        }
      };

      adminTab.addEventListener('touchstart', startPress);
      adminTab.addEventListener('touchend', cancelPress);
      adminTab.addEventListener('touchcancel', cancelPress);
    });

    function showSection(id){
      document.querySelectorAll('.section').forEach(s=>s.style.display='none');
      const el = document.getElementById(id);
      if(el) el.style.display='block';
      if (typeof updateSystemButtonVisibility === 'function') updateSystemButtonVisibility(id);
    }

    function openPopup(url){
      if(url && url.startsWith('javascript:')){
        new Function(url.slice('javascript:'.length))();
      } else {
        window.open(url, '_blank', 'popup=yes,toolbar=no,location=no,status=no,menubar=no,scrollbars=yes,resizable=yes,width=1200,height=800');
      }
    }
    function copyDescription(){
      const txt = document.getElementById('uploadDesc')?.value || '';
      if(navigator.clipboard?.writeText){
        navigator.clipboard.writeText(txt).then(()=>alert('Description copied to clipboard.')).catch(()=>alert('Clipboard blocked. Copy manually.'));
      } else { alert('Clipboard not available. Copy manually.'); }
    }
    function openUploadPages(){
      const urls = [];
      if(document.getElementById('tYouTube')?.checked)  urls.push('https://www.youtube.com/upload');
      if(document.getElementById('tFacebook')?.checked) urls.push('https://www.facebook.com/creatorstudio');
      if(document.getElementById('tInstagram')?.checked) urls.push('https://www.instagram.com/');
      if(document.getElementById('tTikTok')?.checked)    urls.push('https://www.tiktok.com/upload?lang=en');
      if(!urls.length){ alert('Select at least one target.'); return; }
      const features = 'popup=yes,toolbar=no,location=no,status=no,menubar=no,scrollbars=yes,resizable=yes,width=1200,height=800';
      const wins = urls.map(()=>window.open('about:blank','_blank',features));
      wins.forEach((w,i)=>{ try{ if(w) w.location = urls[i]; }catch(e){} });
      if(!wins[0]) alert('Your browser blocked popups. Allow popups for this page.');
    }

    const manageableSections = [
      { id:'main',      label:'Main Links' },
      { id:'luxury',    label:'Luxury Suites' },
      { id:'accounts',  label:'Ticket Accounts' },
      { id:'travel',    label:'Travel' },
      { id:'social',    label:'Social' },
      { id:'domains',   label:'A1 Domains & Emails' },
      { id:'privatejet',label:'Private Jet (within Travel)' },
      { id:'luxhomes',  label:'Luxury Homes (within Travel)' },
      { id:'yachts',    label:'Yachts (within Travel)' } 
    ];
    window.manageableSections = manageableSections;

    function loadState(){
      try{ return JSON.parse(localStorage.getItem(STORAGE_KEY)) || { added:{}, removed:{} }; }
      catch{ return { added:{}, removed:{} }; }
    }
    function saveState(state){ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }
    function sectionGrid(id){ return document.querySelector(`.grid[data-section="${id}"]`); }
    function createBtn(label, url, isCustom=true){
      const btn = document.createElement('button');
      btn.className = 'btn';
      btn.textContent = label;
      btn.setAttribute('data-label', label);
      if (url) btn.dataset.url = url;
      if(isCustom) btn.setAttribute('data-custom','1');
      btn.addEventListener('click', ()=>openPopup(url));
      return btn;
    }

    async function fetchRemoteConfig(){
      for (const base of CONFIG_URLS) {
        try {
          const res = await fetch(`${base}?v=${Date.now()}`, { cache: 'no-store' });
          if (res.ok) {
            const json = await res.json();
            return (json && typeof json === 'object') ? json : { added:{}, removed:{} };
          }
        } catch(_) {}
      }
      return { added:{}, removed:{} };
    }

    function normLabel(s){
      return (s || "").normalize("NFKC").replace(/\s+/g," ").trim().toLowerCase();
    }

    async function checkForUpdatesNow(){
      try {
        const reg = await navigator.serviceWorker.getRegistration();
        if (!reg) return;
        await reg.update();
      } catch(e) {
        console.warn('Update check failed', e);
      }
    }

    function populateRemoveList(){
      const sec  = document.getElementById('removeSection').value;
      const grid = sectionGrid(sec);
      const list = document.getElementById('removeButton');
      list.innerHTML = '';
      if (!grid) return;
      [...grid.querySelectorAll('.btn')].forEach(b=>{
        const raw = b.textContent.trim();
        const o = document.createElement('option');
        o.value = normLabel(raw);
        o.textContent = raw;
        o.setAttribute('data-raw', raw);
        list.appendChild(o);
      });
    }

    function mergeStates(base, remote){
      const merged = JSON.parse(JSON.stringify(base || { added:{}, removed:{} }));

      for (const [sec, arr] of Object.entries((remote && remote.added) || {})) {
        merged.added[sec] = merged.added[sec] || [];
        const seen = new Map(merged.added[sec].map(x => [normLabel(x.label), x]));
        (arr || []).forEach(item => {
          const nl = normLabel(item.label);
          if (!seen.has(nl)) {
            seen.set(nl, { label: item.label, url: item.url });
          } else {
            const prev = seen.get(nl);
            if (item.url && item.url !== prev.url) {
              seen.set(nl, { label: prev.label, url: item.url });
            }
          }
        });
        merged.added[sec] = Array.from(seen.values());
      }

      for (const [sec, labels] of Object.entries((remote && remote.removed) || {})) {
        const prev = new Set((merged.removed?.[sec] || []).map(normLabel));
        const next = new Set((labels || []).map(normLabel));
        merged.removed = merged.removed || {};
        merged.removed[sec] = Array.from(new Set([...prev, ...next]));
      }

      const allSecs = new Set([
        ...Object.keys(merged.added || {}),
        ...Object.keys(merged.removed || {})
      ]);

      for (const sec of allSecs) {
        const remSet = new Set((merged.removed?.[sec] || []).map(normLabel));
        if (merged.added && merged.added[sec]) {
          merged.added[sec] = merged.added[sec].filter(x => !remSet.has(normLabel(x.label)));
        }
      }

      return merged;
    }

    function compareLabels(a, b){
      return normLabel(a).localeCompare(normLabel(b));
    }

    function insertButtonSorted(grid, btn){
      const target = normLabel(btn.textContent);
      const buttons = [...grid.querySelectorAll('.btn')];
      const idx = buttons.findIndex(b => compareLabels(b.textContent, target) > 0);
      if (idx === -1) grid.appendChild(btn);
      else grid.insertBefore(btn, buttons[idx]);
    }

    function getBtnURL(btn){
      if (btn && btn.dataset && btn.dataset.url) return btn.dataset.url;
      const onclick = btn ? (btn.getAttribute('onclick') || '') : '';
      const m = onclick.match(/openPopup\(['"](.+?)['"]\)/);
      return m ? m[1] : '';
    }

    function wireHoverStatus(){
      const bar = document.getElementById('linkStatus');
      if (!bar) return;
      const buttons = document.querySelectorAll('.grid .btn');
      buttons.forEach(btn => {
        if (btn.dataset && btn.dataset.hoverWired === '1') return;
        const url = getBtnURL(btn);
        btn.dataset.hoverWired = '1';
        btn.addEventListener('mouseenter', ()=>{ bar.textContent = url || ''; });
        btn.addEventListener('focus',      ()=>{ bar.textContent = url || ''; });
        btn.addEventListener('mouseleave', ()=>{ bar.textContent = ''; });
        btn.addEventListener('blur',       ()=>{ bar.textContent = ''; });
      });
    }

    function applyState(state){
      document.querySelectorAll('.grid[data-section]').forEach(g => g.innerHTML = '');
      seedDOM();

      const removedMap = {};
      Object.entries(state.removed || {}).forEach(([sec, labels]) => {
        const grid = sectionGrid(sec);
        if (!grid) return;
        const set = new Set((labels || []).map(normLabel));
        removedMap[sec] = set;

        [...grid.querySelectorAll('.btn')].forEach(b => {
          if (set.has(normLabel(b.textContent))) b.remove();
        });
      });

      Object.entries(state.added || {}).forEach(([sec, arr]) => {
        const grid = sectionGrid(sec);
        if (!grid) return;

        const removedSet = removedMap[sec] || new Set();
        const existing = new Set([...grid.querySelectorAll('.btn')].map(b => normLabel(b.textContent)));

        const sorted = [...(arr || [])].sort((a, b) => compareLabels(a.label, b.label));
        sorted.forEach(({ label, url }) => {
          const nl = normLabel(label);
          if (removedSet.has(nl)) return;
          if (existing.has(nl))  return;
          insertButtonSorted(grid, createBtn(label, url, true));
          existing.add(nl);
        });
      });
      wireHoverStatus();
    }

    const bc = 'BroadcastChannel' in window ? new BroadcastChannel('a1vip-sync') : null;
    function broadcastRefresh(){ bc && bc.postMessage({ type:'REFRESH_REMOTE' }); }
    bc && bc.addEventListener('message', async (ev)=>{
      if (ev.data?.type === 'REFRESH_REMOTE') {
        const remote = await fetchRemoteConfig();
        const merged = mergeStates(loadState(), remote);
        saveState(merged);
        applyState(merged);
      }
    });

    let lastRemoteSig = null;
    async function fingerprint(obj){
      const txt = JSON.stringify(obj);
      const buf = new TextEncoder().encode(txt);
      const hash = await crypto.subtle.digest('SHA-256', buf);
      return Array.from(new Uint8Array(hash)).map(b=>b.toString(16).padStart(2,'0')).join('');
    }
    async function refreshFromRemoteIfChanged(){
      try{
        const remote = await fetchRemoteConfig();
        const sig = await fingerprint(remote);
        if (sig !== lastRemoteSig) {
          lastRemoteSig = sig;
          const merged = mergeStates(loadState(), remote);
          saveState(merged);
          applyState(merged);
        }
      }catch{}
    }

    async function init(){
      seedDOM();
      const localState = loadState();
      const remote = await fetchRemoteConfig();
      lastRemoteSig = await fingerprint(remote);
      const merged = mergeStates(localState, remote);
      saveState(merged);
      applyState(merged);
      try{
        const savedColor = localStorage.getItem('a1vip-theme-color');
        if (savedColor){
          setThemeColor(savedColor);
          const picker = document.getElementById('themeColor');
          if (picker) picker.value = savedColor;
        }
      }catch(e){}
      setInterval(refreshFromRemoteIfChanged, 30000);
    }

    async function syncRemote(state){
      if(!SYNC_ENDPOINT) return;
      try{
        const res = await fetch(SYNC_ENDPOINT, {
          method: 'POST',
          headers: { 'Content-Type':'application/json', 'X-A1VIP-Secret': SHARED_SECRET },
          body: JSON.stringify(state)
        });
        const text = await res.text();
        if (!res.ok) {
          console.error('Sync failed', res.status, text);
          alert(`Sync failed: ${res.status}\n${text}`);
          return;
        }
        setTimeout(async ()=>{
          const remote = await fetchRemoteConfig();
          const merged = mergeStates(loadState(), remote);
          saveState(merged);
          applyState(merged);
          broadcastRefresh();
        }, 1200);
      }catch(e){
        console.warn('Remote sync error:', e);
        alert('Remote sync error: ' + e.message);
      }
    }

    async function confirmAdd(){
      const sec   = document.getElementById('addSection').value;
      const label = document.getElementById('addLabel').value.trim();
      const url   = document.getElementById('addUrl').value.trim();
      if(!sec || !label || !url){ alert('Please complete all fields.'); return; }

      const grid = sectionGrid(sec);
      if(!grid){ alert('Section not found.'); return; }

      const newBtn = createBtn(label, url, true);
      insertButtonSorted(grid, newBtn);

      const state = loadState();
      if(!state.added[sec]) state.added[sec] = [];
      const n = normLabel(label);
      const idx = state.added[sec].findIndex(x => normLabel(x.label) === n);
      if (idx >= 0) state.added[sec][idx].url = url;
      else state.added[sec].push({ label, url });
      state.added[sec].sort((a,b)=> compareLabels(a.label, b.label));

      if (state.removed[sec]) {
        state.removed[sec] = state.removed[sec].filter(l => normLabel(l) !== n);
      }

      saveState(state);
      closeModal('addModal');
      alert('Button added.');

      const remote = await fetchRemoteConfig();
      const merged = mergeStates(state, remote);

      if (!merged.removed) merged.removed = {};
      if (!merged.removed[sec]) merged.removed[sec] = [];
      merged.removed[sec] = merged.removed[sec].filter(l => normLabel(l) !== n);

      await syncRemote(merged);
    }

    async function addQuickLinkButton(){
      const input = document.getElementById('quickLinkInput');
      if (!input) return;
      let url = normalizeUrl(input.value);
      if (!url){ alert('Please enter a link first.'); return; }

      let label;
      try{
        const u = new URL(url);
        label = u.hostname.replace(/^www\./,'');
      }catch(e){
        label = url;
      }
      const custom = prompt('Button label for this link:', label);
      if (!custom) return;
      label = custom.trim();
      if (!label){
        alert('Label cannot be empty.');
        return;
      }

      const sec = 'main';
      const grid = sectionGrid(sec);
      if (!grid){
        alert('Main section not found.');
        return;
      }

      const n = normLabel(label);

      const existing = [...grid.querySelectorAll('.btn')].find(
        b => normLabel(b.textContent) === n
      );
      if (existing){
        existing.setAttribute('onclick', `openPopup('${url}')`);
        existing.dataset.url = url;
        existing.setAttribute('data-quick','1');
      } else {
        const newBtn = createBtn(label, url, true);
        newBtn.setAttribute('data-quick','1');
        insertButtonSorted(grid, newBtn);
      }

      const state = loadState();
      if (!state.added[sec]) state.added[sec] = [];
      const idx = state.added[sec].findIndex(x => normLabel(x.label) === n);
      if (idx >= 0) state.added[sec][idx].url = url;
      else state.added[sec].push({ label, url });
      state.added[sec].sort((a,b)=> compareLabels(a.label, b.label));

      if (state.removed[sec]){
        state.removed[sec] = state.removed[sec].filter(l => normLabel(l) !== n);
      }

      saveState(state);

      try{
        const remote = await fetchRemoteConfig();
        const merged = mergeStates(state, remote);
        if (!merged.removed) merged.removed = {};
        if (!merged.removed[sec]) merged.removed[sec] = [];
        merged.removed[sec] = merged.removed[sec].filter(l => normLabel(l) !== n);
        await syncRemote(merged);
      }catch(e){
        console.warn('sync quick add failed', e);
      }

      wireHoverStatus();
      alert('Button added to Main.');
    }

    function normalizeUrl(raw){
      raw = (raw || '').trim();
      if (!raw) return '';
      if (!/^https?:\/\//i.test(raw)){ raw = 'https://' + raw; }
      return raw;
    }

    function openQuickLink(){
      const input = document.getElementById('quickLinkInput');
      if (!input) return;
      const url = normalizeUrl(input.value);
      if (!url){ alert('Please enter a link first.'); return; }
      openPopup(url);
    }

    function openAddModal(){
      fillSelect('addSection');
      const l = document.getElementById('addLabel'); if(l) l.value = '';
      const u = document.getElementById('addUrl');   if(u) u.value = '';
      showModal('addModal');
    }
    function openRemoveModal(){
      fillSelect('removeSection');
      populateRemoveList();
      showModal('removeModal');
    }
    function fillSelect(selectId){
      const sel = document.getElementById(selectId);
      if(!sel) return;
      sel.innerHTML = '';
      const list = (typeof manageableSections !== 'undefined' && Array.isArray(manageableSections))
        ? manageableSections
        : (window.manageableSections || []);
      list.forEach(s=>{
        const opt = document.createElement('option');
        opt.value = s.id;
        opt.textContent = s.label;
        sel.appendChild(opt);
      });
    }
    function showModal(id){
      const m = document.getElementById(id);
      if(m) m.style.display='flex';
    }
    function closeModal(id){
      const m = document.getElementById(id);
      if(m) m.style.display='none';
    }

    function openRenameModal(){
      fillSelect('renameSection');
      populateRenameList();
      showModal('renameModal');
    }

    function populateRenameList(){
      const sec = document.getElementById('renameSection').value;
      const list = document.getElementById('renameButton');
      if (!list) return;
      list.innerHTML = '';
      const grid = sectionGrid(sec);
      if (!grid) return;
      [...grid.querySelectorAll('.btn')].forEach(b => {
        const raw = (b.textContent || '').trim();
        if (!raw) return;
        const opt = document.createElement('option');
        opt.value = raw;
        opt.textContent = raw;
        list.appendChild(opt);
      });
    }

    function getButtonURL(sectionId, rawLabel){
      const grid = sectionGrid(sectionId);
      if (grid){
        const btn = [...grid.querySelectorAll('.btn')].find(b => normLabel(b.textContent) === normLabel(rawLabel));
        if (btn && btn.dataset && btn.dataset.url) return btn.dataset.url;
      }
      const state = loadState();
      const arr = (state.added && state.added[sectionId]) || [];
      const found = arr.find(x => normLabel(x.label) === normLabel(rawLabel));
      if (found && found.url) return found.url;
      const seedArr = (SEED && SEED[sectionId]) || [];
      for (const pair of seedArr){
        const [lbl, url] = pair;
        if (normLabel(lbl) === normLabel(rawLabel)) return url;
      }
      return '';
    }

    async function confirmRename(){
      const sec = document.getElementById('renameSection').value;
      const oldLabel = document.getElementById('renameButton').value;
      const newLabel = (document.getElementById('renameNewLabel').value || '').trim();
      if (!sec || !oldLabel || !newLabel){
        alert('Please choose a section, a button, and enter a new label.');
        return;
      }
      if (normLabel(oldLabel) === normLabel(newLabel)){
        alert('New label must be different.');
        return;
      }
      const grid = sectionGrid(sec);
      if (!grid){
        alert('Section not found.');
        return;
      }

      const conflict = [...grid.querySelectorAll('.btn')].some(
        b => normLabel(b.textContent) === normLabel(newLabel)
      );
      if (conflict){
        alert('A button with that label already exists in this section.');
        return;
      }

      const btn = [...grid.querySelectorAll('.btn')].find(
        b => normLabel(b.textContent) === normLabel(oldLabel)
      );
      if (!btn){
        alert('Button not found.');
        return;
      }
      const url = getButtonURL(sec, oldLabel);

      btn.textContent = newLabel;
      btn.setAttribute('data-label', newLabel);

      const buttons = [...grid.querySelectorAll('.btn')];
      buttons.sort((a,b) => compareLabels(a.textContent, b.textContent));
      grid.innerHTML = '';
      buttons.forEach(b => grid.appendChild(b));

      const state = loadState();
      state.added = state.added || {};
      state.removed = state.removed || {};
      state.added[sec] = state.added[sec] || [];
      state.removed[sec] = state.removed[sec] || [];

      const nOld = normLabel(oldLabel);
      const nNew = normLabel(newLabel);

      let found = false;
      for (const item of state.added[sec]){
        if (normLabel(item.label) === nOld){
          item.label = newLabel;
          item.url = url || item.url || '#';
          found = true;
          break;
        }
      }
      if (!found){
        const remSet = new Set(state.removed[sec].map(normLabel));
        if (!remSet.has(nOld)){
          state.removed[sec].push(oldLabel);
        }
        state.added[sec].push({ label:newLabel, url:url || '#' });
      }

      state.removed[sec] = state.removed[sec].filter(l => normLabel(l) !== nNew);
      state.added[sec].sort((a,b) => compareLabels(a.label, b.label));

      saveState(state);

      try{
        const remote = await fetchRemoteConfig();
        const merged = mergeStates(state, remote);
        await syncRemote(merged);
      }catch(e){
        console.warn('sync rename failed', e);
      }

      wireHoverStatus();
      closeModal('renameModal');
      alert('Button renamed.');
    }

    function openMoveModal(){
      fillSelect('moveFrom');
      fillSelect('moveTo');
      populateMoveList();
      showModal('moveModal');
    }
    function populateMoveList(){
      const sec  = document.getElementById('moveFrom').value;
      const grid = sectionGrid(sec);
      const list = document.getElementById('moveButton');
      list.innerHTML = '';
      if (!grid) return;
      [...grid.querySelectorAll('.btn')].forEach(b=>{
        const raw = b.textContent.trim();
        const o = document.createElement('option');
        o.value = normLabel(raw);
        o.textContent = raw;
        o.setAttribute('data-raw', raw);
        list.appendChild(o);
      });
    }

    async function confirmMove(){
      const from = document.getElementById('moveFrom').value;
      const to   = document.getElementById('moveTo').value;
      const sel  = document.getElementById('moveButton');
      if (!from || !to || !sel.value){ alert('Please choose sections and a button.'); return; }
      if (from === to){ alert('Pick a different destination section.'); return; }

      const rawLabel = sel.options[sel.selectedIndex].getAttribute('data-raw');
      const nLabel   = normLabel(rawLabel);

      const url = getButtonURL(from, rawLabel) || '#';

      const fromGrid = sectionGrid(from);
      const toGrid   = sectionGrid(to);
      if (!fromGrid || !toGrid){ alert('Section not found.'); return; }
      [...fromGrid.querySelectorAll('.btn')].forEach(b => {
        if (normLabel(b.textContent) === nLabel) b.remove();
      });
      const newBtn = createBtn(rawLabel, url, true);
      insertButtonSorted(toGrid, newBtn);

      const state = loadState();
      state.added   = state.added   || {};
      state.removed = state.removed || {};
      state.added[from]   = state.added[from]   || [];
      state.added[to]     = state.added[to]     || [];
      state.removed[from] = state.removed[from] || [];
      state.removed[to]   = state.removed[to]   || [];

      const fromIdx = state.added[from].findIndex(x => normLabel(x.label) == nLabel);
      if (fromIdx >= 0){
        state.added[from].splice(fromIdx, 1);
      } else {
        const remSet = new Set(state.removed[from].map(normLabel));
        if (!remSet.has(nLabel)) state.removed[from].push(rawLabel);
      }

      state.removed[to] = state.removed[to].filter(l => normLabel(l) !== nLabel);

      const toIdx = state.added[to].findIndex(x => normLabel(x.label) == nLabel);
      if (toIdx >= 0){
        state.added[to][toIdx].url = url || state.added[to][toIdx].url || '#';
      } else {
        state.added[to].push({ label: rawLabel, url: url || '#' });
        state.added[to].sort((a,b)=> compareLabels(a.label, b.label));
      }

      saveState(state);

      const remote = await fetchRemoteConfig();
      const merged = mergeStates(state, remote);
      await syncRemote(merged);

      closeModal('moveModal');
      alert('Button moved.');
    }

    async function confirmRemove(){
      const sec = document.getElementById('removeSection').value;
      const sel = document.getElementById('removeButton');
      if (!sec || !sel.value) { alert('Pick a button to remove.'); return; }

      const rawLabel = sel.options[sel.selectedIndex].getAttribute('data-raw');
      const nLabel   = normLabel(rawLabel);

      const grid = sectionGrid(sec);
      if (!grid) { alert('Section not found.'); return; }

      [...grid.querySelectorAll('.btn')].forEach(b => {
        if (normLabel(b.textContent) === nLabel) b.remove();
      });

      const state = loadState();

      if (state.added[sec]) {
        state.added[sec] = state.added[sec].filter(x => normLabel(x.label) !== nLabel);
      }

      state.removed[sec] = state.removed[sec] || [];
      const already = new Set(state.removed[sec].map(l => normLabel(l)));
      if (!already.has(nLabel)) state.removed[sec].push(rawLabel);

      saveState(state);
      closeModal('removeModal');
      alert('Button removed.');

      const remote = await fetchRemoteConfig();
      const merged = mergeStates(state, remote);
      await syncRemote(merged);
    }

    window.addEventListener('DOMContentLoaded', init);
  </script>

  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', async () => {
        try {
          const reg = await navigator.serviceWorker.register('./sw.v4.js');

          function showUpdatePrompt(waitingSW) {
            const bar = document.createElement('div');
            bar.style.cssText = 'position:fixed;left:0;right:0;bottom:0;padding:12px 16px;background:#111827;color:#fff;display:flex;gap:12px;align-items:center;justify-content:center;z-index:9999;border-top:1px solid rgba(148,163,184,.22)';
            bar.innerHTML = `
              <span>New update available.</span>
              <button id="a1vip-update" style="background:#22d3ee;border:none;color:#0b1220;font-weight:800;border-radius:10px;padding:8px 12px;cursor:pointer;">Update</button>
              <button id="a1vip-dismiss" style="background:transparent;border:1px solid rgba(148,163,184,.22);color:#e5e7eb;border-radius:10px;padding:8px 12px;cursor:pointer;">Later</button>
            `;
            document.body.appendChild(bar);

            document.getElementById('a1vip-dismiss').onclick = () => bar.remove();
            document.getElementById('a1vip-update').onclick = () => {
              waitingSW.postMessage({ type: 'SKIP_WAITING' });
            };

            navigator.serviceWorker.addEventListener('controllerchange', () => {
              setTimeout(() => window.location.reload(), 100);
            });
          }

          if (reg.waiting) showUpdatePrompt(reg.waiting);

          reg.addEventListener('updatefound', () => {
            const newSW = reg.installing;
            if (!newSW) return;
            newSW.addEventListener('statechange', () => {
              if (newSW.state === 'installed' && reg.waiting) {
                showUpdatePrompt(reg.waiting);
              }
            });
          });

          setInterval(() => reg.update().catch(()=>{}), 30 * 60 * 1000);
        } catch (e) {
          console.error('SW registration failed', e);
        }
      });
    }
  </script>
</body>
</html>
