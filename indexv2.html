<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>A1 VIP Ticket Dashboard</title>

  <!-- PWA hooks -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#0b1220">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="A1VIP">
  <link rel="apple-touch-icon" href="icons/apple-touch-icon.png">

  <style>
    :root { --bg:#0b1220; --text:#e5e7eb; --border:rgba(148,163,184,.22);
            --gold:#facc15; --blue:#3b82f6; --pink:#ec4899; --red:#ef4444; --black:#000; }
    html,body{margin:0;padding:0;height:100%}
    body{font-family:Arial,Helvetica,sans-serif;background:var(--bg);color:var(--text);display:flex;flex-direction:column}

    header{position:sticky;top:0;z-index:1000;padding:10px 16px;padding-top:calc(env(safe-area-inset-top) + 8px);background:#111827;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:12px;}
    header img{height:150px}
    .title{font-size:2.1rem;line-height:1.05;font-weight:900;letter-spacing:.2px}

    #installBtn{position:fixed;top:calc(env(safe-area-inset-top) + 8px);left:8px;z-index:1200;display:none;background:#16a34a;color:#fff;border:none;padding:8px 10px;border-radius:10px;font-weight:800;cursor:pointer}

    .top-tabs{padding:12px 16px 6px;background:linear-gradient(180deg,#0b1220 0%,rgba(11,18,32,.7) 100%)}
    .tabs-scroller{display:flex;gap:10px;overflow-x:auto;-webkit-overflow-scrolling:touch;scroll-snap-type:x mandatory}
    .tabs-scroller::-webkit-scrollbar{display:none}
    .tab{flex:0 0 auto;scroll-snap-align:start;border:none;padding:10px 16px;border-radius:12px;cursor:pointer;font-weight:800;color:#fff;user-select:none;box-shadow:0 0 0 1px rgba(148,163,184,.22) inset;transition:.2s}
    .tab-main{background:var(--gold);color:#000}.tab-main:hover{background:#ffe44d}
    .tab-luxury{background:var(--blue)}.tab-luxury:hover{background:#60a5fa}
    .tab-accounts{background:var(--pink)}.tab-accounts:hover{background:#f472b6}
    .tab-travel{background:var(--red)}.tab-travel:hover{background:#f87171}
    .tab-social{background:#000}.tab-social:hover{background:#1f2937}
    .tab-admin{background:#fff;color:#000}.tab-admin:hover{background:#e5e7eb}

    main{flex:1;overflow:auto;-webkit-overflow-scrolling:touch;padding:16px 16px 28px}
    .section{margin-bottom:30px}
    h3{color:#facc15;font-size:1.3rem;margin:10px 4px 14px}

    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:16px}
    .btn{display:flex;align-items:center;justify-content:center;gap:10px;padding:16px;border-radius:16px;background:#1e293b;color:#fff;font-weight:800;border:1px solid var(--border);transition:.25s;text-align:center}
    .btn:hover{background:#facc15;color:#000;box-shadow:0 0 15px #facc15}

    details{background:#0f172a;border:1px solid var(--border);border-radius:12px;margin:10px 0}
    summary{cursor:pointer;font-weight:800;padding:10px 14px;color:#e5e7eb}
    details .inner{padding:12px}
    .note{color:#9ca3af;font-size:.9rem}

    .upload-card{background:#0f172a;border:1px solid var(--border);border-radius:14px;padding:16px;display:grid;gap:14px}
    .upload-grid{display:grid;grid-template-columns:1fr;gap:14px}
    .upload-grid label{font-weight:700}
    .upload-grid textarea{width:100%;min-height:120px;border-radius:10px;border:1px solid var(--border);background:#111827;color:#e5e7eb;padding:10px}
    .upload-grid input[type=file]{border:1px dashed var(--border);padding:12px;border-radius:10px;background:#0b1220;color:#e5e7eb}
    .targets{display:flex;flex-wrap:wrap;gap:10px}
    .chip{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--border);padding:8px 12px;border-radius:999px;background:#111827}
    .upload-actions{display:flex;flex-wrap:wrap;gap:12px}
    .cta{border:none;border-radius:10px;padding:10px 14px;font-weight:800;cursor:pointer}
    .cta-primary{background:#22d3ee;color:#0b1220}.cta-primary:hover{filter:brightness(1.1)}
    .cta-secondary{background:#facc15;color:#0b1220}.cta-secondary:hover{filter:brightness(1.05)}

    .manager-row{display:flex;flex-wrap:wrap;gap:12px;margin-top:8px}
    .btn-add{background:#16a34a}.btn-add:hover{filter:brightness(1.05)}
    .btn-remove{background:#ef4444}.btn-remove:hover{filter:brightness(1.05)}
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;z-index:2000}
    .modal-card{width:min(560px,92vw);background:#0f172a;border:1px solid var(--border);border-radius:16px;padding:16px;box-shadow:0 10px 30px rgba(0,0,0,.5)}
    .modal h4{margin:0 0 12px;color:#facc15}
    .form-grid{display:grid;gap:12px}
    .form-grid label{font-weight:700}
    .form-grid select,.form-grid input{width:100%;padding:10px;border-radius:10px;border:1px solid var(--border);background:#111827;color:#e5e7eb}
    .modal-actions{display:flex;gap:10px;justify-content:flex-end;margin-top:12px}
    .ghost{background:transparent;border:1px solid var(--border);color:#e5e7eb}
  </style>
</head>
<body>
  <header>
    <img src="A1VIP_LOGO_VERT_for _Black_backgrounds.png" alt="Logo">
    <div class="title">A1 VIP<br/>Ticket<br/>Dashboard</div>
  </header>

  <button id="installBtn">Install App</button>

  <nav class="top-tabs">
    <div class="tabs-scroller">
      <button class="tab tab-main" onclick="showSection('main')">Main Links</button>
      <button class="tab tab-luxury" onclick="showSection('luxury')">Luxury Suites</button>
      <button class="tab tab-accounts" onclick="showSection('accounts')">Ticket Accounts</button>
      <button class="tab tab-travel" onclick="showSection('travel')">Travel</button>
      <button class="tab tab-social" onclick="showSection('social')">Social</button>
      <button class="tab tab-admin" onclick="showSection('admin')">Admin</button>
    </div>
  </nav>

  <main>
    <div id="main" class="section">
      <h3>Main Links</h3>
      <div class="grid" data-section="main"></div>
    </div>

    <div id="luxury" class="section" style="display:none;">
      <h3>Luxury Suites</h3>
      <div class="grid" data-section="luxury"></div>
    </div>

    <div id="accounts" class="section" style="display:none;">
      <h3>Ticket Accounts</h3>
      <div class="grid" data-section="accounts"></div>
    </div>

    <div id="travel" class="section" style="display:none;">
      <h3>Travel</h3>
      <div class="grid" data-section="travel"></div>

      <details>
        <summary>Private Jet</summary>
        <div class="inner">
          <div class="grid" data-section="privatejet"></div>
        </div>
      </details>

      <details>
        <summary>Luxury Homes</summary>
        <div class="inner">
          <div class="grid" data-section="luxhomes"></div>
        </div>
      </details>
    </div>

    <div id="social" class="section" style="display:none;">
      <h3>Social</h3>
      <div class="grid" data-section="social"></div>
    </div>

    <div id="admin" class="section" style="display:none;">
      <h3>Admin</h3>
      <div class="grid">
        <button class="btn" onclick="showSection('domains')">A1 Domains & Emails</button>
        <button class="btn" onclick="openPopup('https://a1vipevents.com/')">A1VIP</button>
        <button class="btn" onclick="openPopup('https://a1vipevents.com/wp-login.php?redirect_to=https%3A%2F%2Fa1vipevents.com%2Fwp-admin%2F&reauth=1')">BackEnd</button>
        <button class="btn" onclick="showSection('upload')">UPLOAD</button>
        <button class="btn" onclick="showSection('buttonManager')">Button Manager</button>
      </div>
    </div>

    <div id="domains" class="section" style="display:none;">
      <h3>A1 Domains & Emails</h3>
      <div class="grid" data-section="domains"></div>
    </div>

    <section id="upload" class="section" style="display:none;">
      <h3>UPLOAD</h3>
      <div class="upload-card">
        <div class="upload-grid">
          <div>
            <label for="uploadDesc">Post Description</label>
            <textarea id="uploadDesc" placeholder="Write the caption / description you want on your posts..."></textarea>
            <div class="note">We’ll copy this to your clipboard so you can paste it on each site.</div>
          </div>
          <div>
            <label for="uploadFile">Video File</label>
            <input id="uploadFile" type="file" accept="video/*" />
            <div class="note">A single HTML file can’t upload to multiple sites without APIs/OAuth. The buttons below open each site’s upload page.</div>
          </div>
          <div>
            <label>Targets</label>
            <div class="targets">
              <label class="chip"><input type="checkbox" id="tYouTube" checked> YouTube</label>
              <label class="chip"><input type="checkbox" id="tFacebook" checked> Facebook</label>
              <label class="chip"><input type="checkbox" id="tInstagram" checked> Instagram</label>
              <label class="chip"><input type="checkbox" id="tTikTok" checked> TikTok</label>
            </div>
          </div>
        </div>
        <div class="upload-actions">
          <button class="cta cta-secondary" onclick="copyDescription()">Copy Description</button>
          <button class="cta cta-primary" onclick="openUploadPages()">Open Upload Pages</button>
          <div class="note">If only one window opens, your browser is blocking multiple popups. Allow popups for this page or open sites one by one.</div>
        </div>
      </div>
    </section>

    <section id="buttonManager" class="section" style="display:none;">
      <h3>Button Manager</h3>
      <div class="manager-row">
        <button class="btn btn-add" onclick="openAddModal()">➕ Add Button</button>
        <button class="btn btn-remove" onclick="openRemoveModal()">➖ Remove Button</button>
          <!-- Admin actions (add near your other manager buttons) -->
<div class="admin-row" style="display:flex; gap:8px; flex-wrap:wrap; margin-top:10px;">
  <button class="btn" style="background:#3182ce" onclick="openMoveModal()">Move Button</button>
  <button class="btn" style="background:#6b46c1" onclick="openCreateSectionModal()">Create Section</button>
</div>
      <div class="note" style="margin-top:8px">
        Changes sync from <code>buttons.json</code>. Writes use a serverless endpoint (configure <code>SYNC_ENDPOINT</code>).
      </div>
    </section>
  </main>

  <!-- Move Button Modal -->
<div id="moveModal" class="modal" style="display:none;">
  <div class="modal-content">
    <h3>Move Button</h3>
    <label>From section</label>
    <select id="moveFrom" onchange="populateMoveButtons()"></select>

    <label>Button</label>
    <select id="moveButton"></select>

    <label>To section</label>
    <select id="moveTo"></select>

    <div class="modal-actions">
      <button class="btn" style="background:#3182ce" onclick="confirmMove()">Move</button>
      <button class="btn" onclick="closeModal('moveModal')">Cancel</button>
    </div>
  </div>
</div>

<!-- Create Section Modal -->
<div id="createSectionModal" class="modal" style="display:none;">
  <div class="modal-content">
    <h3>Create New Section</h3>
    <label>Section title</label>
    <input id="newSectionTitle" placeholder="e.g., Partners" />
    <label>Section id (auto-generated; letters, numbers, dashes)</label>
    <input id="newSectionId" placeholder="partners" />
    <div class="modal-actions">
      <button class="btn" style="background:#6b46c1" onclick="confirmCreateSection()">Create</button>
      <button class="btn" onclick="closeModal('createSectionModal')">Cancel</button>
    </div>
  </div>
</div>
  
  <!-- Add Modal -->
  <div id="addModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="addTitle">
    <div class="modal-card">
      <h4 id="addTitle">Add a New Button</h4>
      <div class="form-grid">
        <label>Section
          <select id="addSection"></select>
        </label>
        <label>Button Label
          <input id="addLabel" type="text" placeholder="e.g., Team Store">
        </label>
        <label>Button URL
          <input id="addUrl" type="url" placeholder="https://example.com">
        </label>
      </div>
      <div class="modal-actions">
        <button class="cta ghost" onclick="closeModal('addModal')">Cancel</button>
        <button class="cta cta-primary" onclick="confirmAdd()">Add</button>
      </div>
    </div>
  </div>

  <!-- Remove Modal -->
  <div id="removeModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="removeTitle">
    <div class="modal-card">
      <h4 id="removeTitle">Remove a Button</h4>
      <div class="form-grid">
        <label>Section
          <select id="removeSection" onchange="populateRemoveList()"></select>
        </label>
        <label>Pick Button to Remove
          <select id="removeButton"></select>
        </label>
      </div>
      <div class="modal-actions">
        <button class="cta ghost" onclick="closeModal('removeModal')">Cancel</button>
        <button class="cta cta-secondary" onclick="confirmRemove()">Remove</button>
      </div>
    </div>
  </div>

  <script>
    /* ===== Config ===== */
    const CONFIG_URLS = [
      'https://raw.githubusercontent.com/paq-man23/a1vip-dashboard/main/buttons.json',
      'https://paq-man23.github.io/a1vip-dashboard/buttons.json'
    ];
    const SYNC_ENDPOINT = 'https://a1vip-sync.jviphone.workers.dev';
    const SHARED_SECRET = 'a1vip-2025-sync-9fK2sX';
    const STORAGE_KEY = 'a1vip-button-manager-v2';

    /* ===== Seed (links preserved) ===== */
    const SEED = {
      main: [
        ["Audience Rewards","https://www.audiencerewards.com/"],
        ["AXS","https://www.axs.com/"],
        ["Braintree","https://www.braintreegateway.com/login"],
        ["Broadway Box Discounts","https://www.broadwaybox.com/"],
        ["Broadwaydirect","https://tickets.broadwaydirect.com/shop/account/login?returnUrl=https://tickets.broadwaydirect.com/Account/Orders"],
        ["Charity buzz","https://www.charitybuzz.com/"],
        ["Chase Gets You In Lounge","https://chasegetsyoucloser.com/login/?msg=200"],
        ["ChatGPT","https://chatgpt.com/"],
        ["Clover Go A1","https://www.clover.com/login?webRedirectUrl=%2Fdashboard"],
        ["Core Ticketevolution","https://core.ticketevolution.com"],
        ["FedEx","https://www.fedex.com/secure-login/en-us/#/credentials"],
        ["Gametime Portal","https://portal.gametime.co/login"],
        ["Mailchimp","https://login.mailchimp.com/login/unified-login"],
        ["M&T Rewards","https://rewards.mtb.com/welcome.htm"],
        ["MLB.com","https://www.mlb.com/login?redirectUri=/apps/ballpark"],
        ["MyTicketmaster","https://www.ticketmaster.com"],
        ["Pollstar","https://www.pollstar.com/login"],
        ["Presale","https://www.presalepasswordinfo.com/members/checkuser.php"],
        ["Quint","https://quint.co/"],
        ["Rate Your Seats","https://www.rateyourseats.com"],
        ["Ryder Cup","https://onlocationexp.com/golf/ryder-cup-tickets"],
        ["SeatGeek","https://seatgeek.com/"],
        ["Seatgeek Portal","https://sellers.seatgeek.com/orders?status=all&selectedTab=all"],
        ["Skybox","https://skybox.vividseats.com/inventory?groupBy=event&sortedBy=event_date&sortDir=asc&limit=100&pageNumber=1&sortedByB=quantity&sortDirB=asc"],
        ["StubHub","https://www.stubhub.com/"],
        ["TAO Suite","https://www.suitesixteenlounge.com/"],
        ["TicketFlipping","https://ticketflipping.com/ticketflipping-toolbox/"],
        ["Ticket Utils","https://app.ticketutils.com/POS/DashBoard"],
        ["Ticketnetwork POS NEXT","https://posnext.ticketnetwork.com/#inventory"],
        ["Trade Desk","https://tradedesk.ticketmaster.com"],
        ["Victory Live","https://www.victorylive.com"],
        ["Vista Print","https://www.vistaprint.com/my-account/design/projects?xnav=accountMenu"]
      ],
      luxury: [
        ["Suite Experience","https://www.suiteexperiencegroup.com/"],
        ["Suite Hop","https://suitehop.com/"],
        ["MSG Premium Hospitality","https://www.msg.com/madison-square-garden/luxury-suites"],
        ["LSA Suites","https://lsaus.com/"],
        ["The Sphere Suites","https://www.thesphere.com/premium-suites"],
        ["Access Sports","https://accessvipsports.com/about-us/"]
      ],
      accounts: [
        ["Dolphins","https://am.ticketmaster.com/dolphins/my-events"],
        ["NY Islanders","https://am.ticketmaster.com/newyorkislanders/my-events#/17998"],
        ["Predators","https://am.ticketmaster.com/predators/my-events"],
        ["Vanderbilt","https://vucommodores.evenue.net/signin"],
        ["Vols","https://am.ticketmaster.com/allvols/my-events"],
        ["Yankees","https://am.ticketmaster.com/nyyreg/my-events"]
      ],
      travel: [
        ["ARCCORP","https://www2.arccorp.com/#"],
        ["Delta","https://www.delta.com/"],
        ["Expedia","https://www.expedia.com/Hotels?v=b"],
        ["EZ-PASS","https://www.e-zpassny.com/vector/account/transactions/transactionlist.do"],
        ["Jetset","https://jetsetjansen.com/versace-mansion-miami/"],
        ["JSX","https://www.jsx.com/home/search"],
        ["Universal","https://www.universalpartnercommunity.com/s/login/SelfRegister?language=en_US"],
        ["Yachts","https://www.burgessyachts.com/en/charter-a-yacht/yachts-for-charter/aquila-00005340"]
      ],
      privatejet: [
        ["Fly XO","https://flyxo.com/"],
        ["Flyte","https://www.flyte.travel/rebrand"],
        ["Private Jet Contracts","javascript:alert('Add contract link URL and I\\'ll wire this up.')"],
        ["Private Jet Fly USA","https://flyusa.com/book-private-flights/"],
        ["Wheels Up","https://wheelsup.com/"]
      ],
      luxhomes: [
        ["Airbnb","https://www.airbnb.com/"],
        ["VRBO","https://www.vrbo.com/"]
      ],
      social: [
        ["Facebook","https://www.facebook.com/"],
        ["Instagram","https://www.instagram.com/"],
        ["LinkedIn","https://www.linkedin.com/"],
        ["Mailchimp","https://mailchimp.com/"],
        ["Tiktok","https://tiktok.com/"],
        ["YouTube","https://www.youtube.com/"]
      ],
      domains: [
        ["A1 Timesheets","https://1drv.ms/x/c/f3acac4cab808f86/EQsA5-xNQvBApOR3XhRkD1EBNC3MT3eW0wlrza-6wpYNPQ?e=fbawZI"],
        ["Domain Pal","https://domainpal.com/"],
        ["GoDaddy","https://www.godaddy.com/"]
      ]
    };

    function seedDOM(){
      Object.entries(SEED).forEach(([sec, items])=>{
        const grid = sectionGrid(sec);
        if(!grid) return;
        items.forEach(([label,url])=> grid.appendChild(createBtn(label,url,false)));
      });
    }
    function showSection(id){
      document.querySelectorAll('.section').forEach(s=>s.style.display='none');
      const el = document.getElementById(id);
      if(el) el.style.display='block';
    }
    function openPopup(url){
      if(url && url.startsWith('javascript:')){
        new Function(url.slice('javascript:'.length))();
      } else {
        window.open(url, '_blank', 'popup=yes,toolbar=no,location=no,status=no,menubar=no,scrollbars=yes,resizable=yes,width=1200,height=800');
      }
    }
    function copyDescription(){
      const txt = document.getElementById('uploadDesc')?.value || '';
      if(navigator.clipboard?.writeText){
        navigator.clipboard.writeText(txt).then(()=>alert('Description copied to clipboard.')).catch(()=>alert('Clipboard blocked. Copy manually.'));
      } else { alert('Clipboard not available. Copy manually.'); }
    }
    function openUploadPages(){
      const urls = [];
      if(document.getElementById('tYouTube')?.checked)  urls.push('https://www.youtube.com/upload');
      if(document.getElementById('tFacebook')?.checked) urls.push('https://www.facebook.com/creatorstudio');
      if(document.getElementById('tInstagram')?.checked) urls.push('https://www.instagram.com/');
      if(document.getElementById('tTikTok')?.checked)    urls.push('https://www.tiktok.com/upload?lang=en');
      if(!urls.length){ alert('Select at least one target.'); return; }
      const features = 'popup=yes,toolbar=no,location=no,status=no,menubar=no,scrollbars=yes,resizable=yes,width=1200,height=800';
      const wins = urls.map(()=>window.open('about:blank','_blank',features));
      wins.forEach((w,i)=>{ try{ if(w) w.location = urls[i]; }catch(e){} });
      if(!wins[0]) alert('Your browser blocked popups. Allow popups for this page.');
    }

    const manageableSections = [
      { id:'main', label:'Main Links' },
      { id:'luxury', label:'Luxury Suites' },
      { id:'accounts', label:'Ticket Accounts' },
      { id:'travel', label:'Travel' },
      { id:'social', label:'Social' },
      { id:'domains', label:'A1 Domains & Emails' },
      { id:'privatejet', label:'Private Jet (within Travel)' },
      { id:'luxhomes', label:'Luxury Homes (within Travel)' },
    ];

     // expose to helpers
     window.manageableSections = manageableSections;

    
    function loadState(){
      try{ return JSON.parse(localStorage.getItem(STORAGE_KEY)) || { added:{}, removed:{} }; }
      catch{ return { added:{}, removed:{} }; }
    }
    function saveState(state){ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }
    function sectionGrid(id){ return document.querySelector(`.grid[data-section="${id}"]`); }
    function createBtn(label, url, isCustom=true){
      const btn = document.createElement('button');
      btn.className = 'btn';
      btn.textContent = label;
      btn.setAttribute('data-label', label);
      btn.dataset.url = url;
      if(isCustom) btn.setAttribute('data-custom','1');
      btn.addEventListener('click', ()=>openPopup(url));
      return btn;
    }

    async function fetchRemoteConfig(){
      for (const base of CONFIG_URLS) {
        try {
          const res = await fetch(`${base}?v=${Date.now()}`, { cache: 'no-store' });
          if (res.ok) {
            const json = await res.json();
            return (json && typeof json === 'object') ? json : { added:{}, removed:{} };
          }
        } catch(_) {}
      }
      return { added:{}, removed:{} };
    }

    function normLabel(s){
      return (s || "").normalize("NFKC").replace(/\s+/g," ").trim().toLowerCase();
    }
async function checkForUpdatesNow(){
  try {
    const reg = await navigator.serviceWorker.getRegistration();
    if (!reg) return;
    await reg.update(); // ask SW to fetch latest
    // Optional: nudge the waiting worker to show the banner immediately if already installed
    if (reg.waiting) {
      // your page logic will display the "New update available" banner
      // (no-op here since your registration code handles reg.waiting)
    }
  } catch(e) {
    console.warn('Update check failed', e);
  }
}
    function populateRemoveList(){
      const sec  = document.getElementById('removeSection').value;
      const grid = sectionGrid(sec);
      const list = document.getElementById('removeButton');
      list.innerHTML = '';
      if (!grid) return;
      [...grid.querySelectorAll('.btn')].forEach(b=>{
        const raw = b.textContent.trim();
        const o = document.createElement('option');
        o.value = normLabel(raw);
        o.textContent = raw;
        o.setAttribute('data-raw', raw);
        list.appendChild(o);
      });
    }

function mergeStates(base, remote){
  // Deep clone base
  const merged = JSON.parse(JSON.stringify(base || { added:{}, removed:{} }));

  // ---- 1) Merge ADDED (union by normalized label; prefer remote URL on conflict)
  for (const [sec, arr] of Object.entries((remote && remote.added) || {})) {
    merged.added[sec] = merged.added[sec] || [];
    const seen = new Map(merged.added[sec].map(x => [normLabel(x.label), x]));
    (arr || []).forEach(item => {
      const nl = normLabel(item.label);
      if (!seen.has(nl)) {
        seen.set(nl, { label: item.label, url: item.url });
      } else {
        const prev = seen.get(nl);
        if (item.url && item.url !== prev.url) {
          seen.set(nl, { label: prev.label, url: item.url });
        }
      }
    });
    merged.added[sec] = Array.from(seen.values());
  }

  // ---- 2) Merge REMOVED (union of normalized strings)
  for (const [sec, labels] of Object.entries((remote && remote.removed) || {})) {
    const prev = new Set((merged.removed?.[sec] || []).map(normLabel));
    const next = new Set((labels || []).map(normLabel));
    merged.removed = merged.removed || {};
    merged.removed[sec] = Array.from(new Set([...prev, ...next]));
  }

  // ---- 3) Reconcile: if a label is in REMOVED, it must NOT remain in ADDED (removal wins)
  const allSecs = new Set([
    ...Object.keys(merged.added || {}),
    ...Object.keys(merged.removed || {})
  ]);

  for (const sec of allSecs) {
    const remSet = new Set((merged.removed?.[sec] || []).map(normLabel));
    if (merged.added && merged.added[sec]) {
      merged.added[sec] = merged.added[sec].filter(x => !remSet.has(normLabel(x.label)));
    }
  }

  return merged;
}

function applyState(state){
  // 1) reset + seed from SEED
  document.querySelectorAll('.grid[data-section]').forEach(g => g.innerHTML = '');
  seedDOM();

  // 2) apply removals (and build lookup for adds)
  const removedMap = {};
  Object.entries(state.removed || {}).forEach(([sec, labels]) => {
    const grid = sectionGrid(sec);
    if (!grid) return;
    const set = new Set((labels || []).map(normLabel));
    removedMap[sec] = set;

    // remove from DOM
    [...grid.querySelectorAll('.btn')].forEach(b => {
      if (set.has(normLabel(b.textContent))) b.remove();
    });
  });

  // 3) apply additions BUT SKIP anything present in removedMap
  Object.entries(state.added || {}).forEach(([sec, arr]) => {
    ensureSectionForId(sec);
    const grid = sectionGrid(sec);
    if (!grid) return;

    const removedSet = removedMap[sec] || new Set();
    const existing = new Set([...grid.querySelectorAll('.btn')].map(b => normLabel(b.textContent)));

    const sorted = [...(arr || [])].sort((a, b) => compareLabels(a.label, b.label));
    sorted.forEach(({ label, url }) => {
      const nl = normLabel(label);
      if (removedSet.has(nl)) return;   // <-- key line: do not re-add if removed
      if (existing.has(nl))  return;    // already present
      insertButtonSorted(grid, createBtn(label, url, true));
      existing.add(nl);
    });
  });
}
    const bc = 'BroadcastChannel' in window ? new BroadcastChannel('a1vip-sync') : null;
    function broadcastRefresh(){ bc && bc.postMessage({ type:'REFRESH_REMOTE' }); }
    bc && bc.addEventListener('message', async (ev)=>{
      if (ev.data?.type === 'REFRESH_REMOTE') {
        const remote = await fetchRemoteConfig();
        const merged = mergeStates(loadState(), remote);
        saveState(merged);
        applyState(merged);
      }
    });

    let lastRemoteSig = null;
    async function fingerprint(obj){
      const txt = JSON.stringify(obj);
      const buf = new TextEncoder().encode(txt);
      const hash = await crypto.subtle.digest('SHA-256', buf);
      return Array.from(new Uint8Array(hash)).map(b=>b.toString(16).padStart(2,'0')).join('');
    }
    async function refreshFromRemoteIfChanged(){
      try{
        const remote = await fetchRemoteConfig();
        const sig = await fingerprint(remote);
        if (sig !== lastRemoteSig) {
          lastRemoteSig = sig;
          const merged = mergeStates(loadState(), remote);
          saveState(merged);
          applyState(merged);
        }
      }catch{}
    }

    async function init(){
      seedDOM();
      const localState = loadState();
      const remote = await fetchRemoteConfig();
      lastRemoteSig = await fingerprint(remote);
      const merged = mergeStates(localState, remote);
      saveState(merged);
      applyState(merged);
      setInterval(refreshFromRemoteIfChanged, 30000);
    }

    async function syncRemote(state){
      if(!SYNC_ENDPOINT) return;
      try{
        const res = await fetch(SYNC_ENDPOINT, {
          method: 'POST',
          headers: { 'Content-Type':'application/json', 'X-A1VIP-Secret': SHARED_SECRET },
          body: JSON.stringify(state)
        });
        const text = await res.text();
        if (!res.ok) {
          console.error('Sync failed', res.status, text);
          alert(`Sync failed: ${res.status}\n${text}`);
          return;
        }
        setTimeout(async ()=>{
          const remote = await fetchRemoteConfig();
          const merged = mergeStates(loadState(), remote);
          saveState(merged);
          applyState(merged);
          broadcastRefresh();
        }, 1200);
      }catch(e){
        console.warn('Remote sync error:', e);
        alert('Remote sync error: ' + e.message);
      }
    }

// Helpers (single copy)
function compareLabels(a, b){
  return normLabel(a).localeCompare(normLabel(b));
}
function insertButtonSorted(grid, btn){
  const target = normLabel(btn.textContent);
  const buttons = [...grid.querySelectorAll('.btn')];
  const idx = buttons.findIndex(b => compareLabels(b.textContent, target) > 0);
  if (idx === -1) grid.appendChild(btn);
  else grid.insertBefore(btn, buttons[idx]);
}

// Alphabetical add + state sort
async function confirmAdd(){
  const sec   = document.getElementById('addSection').value;
  const label = document.getElementById('addLabel').value.trim();
  const url   = document.getElementById('addUrl').value.trim();
  if(!sec || !label || !url){ alert('Please complete all fields.'); return; }

  const grid = sectionGrid(sec);
  if(!grid){ alert('Section not found.'); return; }

  // Insert alphabetically in the DOM
  const newBtn = createBtn(label, url, true);
  insertButtonSorted(grid, newBtn);

  // Update local state (sorted)
  const state = loadState();
  if(!state.added[sec]) state.added[sec] = [];
  const n = normLabel(label);
  const idx = state.added[sec].findIndex(x => normLabel(x.label) === n);
  if (idx >= 0) state.added[sec][idx].url = url;
  else state.added[sec].push({ label, url });
  state.added[sec].sort((a,b)=> compareLabels(a.label, b.label));

  // Clear pending removal locally
  if (state.removed[sec]) {
    state.removed[sec] = state.removed[sec].filter(l => normLabel(l) !== n);
  }

  saveState(state);
  closeModal('addModal');
  alert('Button added.');

  // <-- KEY CHANGE: merge with remote, then scrub the label from merged.removed before syncing
  const remote = await fetchRemoteConfig();
  const merged = mergeStates(state, remote);

  // Scrub this label from the merged removed set so the server file doesn’t keep deleting it
  if (!merged.removed) merged.removed = {};
  if (!merged.removed[sec]) merged.removed[sec] = [];
  merged.removed[sec] = merged.removed[sec].filter(l => normLabel(l) !== n);

  await syncRemote(merged);
}


// ---- Modals / selects ----
function openAddModal(){
  fillSelect('addSection');
  const l = document.getElementById('addLabel'); if(l) l.value = '';
  const u = document.getElementById('addUrl');   if(u) u.value = '';
  showModal('addModal');
}
function openRemoveModal(){
  fillSelect('removeSection');
  populateRemoveList();
  showModal('removeModal');
}
// Create a new section DOM block (top of page)
function createSectionDOM(id, title){
  if (sectionGrid(id)) return; // already exists
  // Wrapper
  const container = document.createElement('section');
  container.className = 'section';
  container.id = `sec-${id}`;
  // Title
  const h = document.createElement('h2');
  h.textContent = title;
  h.style.marginTop = '18px';
  container.appendChild(h);
  // Grid
  const grid = document.createElement('div');
  grid.className = 'grid';
  grid.setAttribute('data-section', id);
  container.appendChild(grid);

  // Insert near top, right after your main title area
  const anchor = document.querySelector('#sectionsTopAnchor') || document.querySelector('.sections') || document.body;
  anchor.prepend(container);
}

// Persist custom sections locally so Admin dropdowns remember them
const STORAGE_SECTIONS = 'a1vip-custom-sections';
function loadCustomSections(){
  try { return JSON.parse(localStorage.getItem(STORAGE_SECTIONS)) || []; }
  catch { return []; }
}
function saveCustomSections(arr){
  localStorage.setItem(STORAGE_SECTIONS, JSON.stringify(arr || []));
}

// Merge default manageableSections with saved custom ones on boot
(function ensureSectionRegistry(){
  const base = (window.manageableSections || []).map(s=>({id:s.id, label:s.label}));
  const custom = loadCustomSections();
  const byId = new Map(base.map(s=>[s.id, s]));
  custom.forEach(s => { if (!byId.has(s.id)) byId.set(s.id, s); });
  window.manageableSections = Array.from(byId.values());
})();

// Allow applyState to auto-create a section when remote state references it
function ensureSectionForId(secId){
  if (sectionGrid(secId)) return;
  // try to find a human label; otherwise Title Case the id
  const found = (window.manageableSections || []).find(s=>s.id===secId);
  const title = found?.label || secId.replace(/[-_]+/g,' ').replace(/\b\w/g, c=>c.toUpperCase());
  createSectionDOM(secId, title);
  // remember new section locally too
  const list = loadCustomSections();
  if (!list.some(s=>s.id===secId)) {
    list.push({ id: secId, label: title });
    saveCustomSections(list);
    // reflect in window.manageableSections
    window.manageableSections = (window.manageableSections||[]).concat([{ id: secId, label: title }]);
  }
}

// MOVE: from one section to another
async function confirmMove(){
  const from = document.getElementById('moveFrom')?.value;
  const to   = document.getElementById('moveTo')?.value;
  const sel  = document.getElementById('moveButton');

  if (!from || !to || !sel || !sel.value) { alert('Pick source, button, and destination.'); return; }
  if (from === to) { alert('Source and destination are the same.'); return; }

  const raw = sel.value;
  const url = sel.options[sel.selectedIndex].dataset.url || '';
  const wasCustom = sel.options[sel.selectedIndex].dataset.custom === '1';

  const fromGrid = sectionGrid(from);
  const toGrid   = (sectionGrid(to) || (ensureSectionForId(to), sectionGrid(to)));
  if (!fromGrid || !toGrid) { alert('Section not found.'); return; }

  // Remove button from source DOM
  [...fromGrid.querySelectorAll('.btn')].forEach(b=>{
    if (b.textContent.trim()===raw) b.remove();
  });

  // Add button to target DOM (alphabetically)
  insertButtonSorted(toGrid, createBtn(raw, url, true));

  // Update state
  const state = loadState();
  state.added[from] = state.added[from] || [];
  state.added[to]   = state.added[to]   || [];

  const n = normLabel(raw);

  if (wasCustom){
    // move inside 'added': remove from source.added, add to target.added
    state.added[from] = state.added[from].filter(x=>normLabel(x.label)!==n);
    if (!state.added[to].some(x=>normLabel(x.label)===n)){
      state.added[to].push({ label: raw, url });
    }
  } else {
    // was a seed button: mark removed in source, add to target.added
    state.removed[from] = state.removed[from] || [];
    if (!state.removed[from].some(l=>normLabel(l)===n)) state.removed[from].push(raw);
    if (!state.added[to].some(x=>normLabel(x.label)===n)){
      state.added[to].push({ label: raw, url });
    }
  }

  // keep target alphabetical
  state.added[to].sort((a,b)=>compareLabels(a.label,b.label));

  saveState(state);
  closeModal('moveModal');
  alert('Button moved.');

  // Sync
  const remote = await fetchRemoteConfig();
  const merged = mergeStates(state, remote);
  await syncRemote(merged);
}

// CREATE SECTION: adds a new section at the top; appears on other devices once a button is added or moved into it
async function confirmCreateSection(){
  const titleEl = document.getElementById('newSectionTitle');
  const idEl    = document.getElementById('newSectionId');
  let title = (titleEl?.value || '').trim();
  let id    = (idEl?.value || '').trim();

  if (!title) { alert('Please enter a section title.'); return; }
  if (!id) {
    id = title.toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/^-+|-+$/g,'');
  }
  if (!/^[a-z0-9\-]+$/.test(id)) { alert('Section id must be letters, numbers, dashes.'); return; }

  // prevent duplicates
  const exists = (window.manageableSections || []).some(s=>s.id===id) || !!sectionGrid(id);
  if (exists) { alert('A section with that id already exists.'); return; }

  // Create visually and register
  createSectionDOM(id, title);
  const customs = loadCustomSections();
  customs.push({ id, label: title });
  saveCustomSections(customs);
  window.manageableSections = (window.manageableSections || []).concat([{ id, label: title }]);

  closeModal('createSectionModal');
  alert('Section created. It will sync to other devices once you add or move a button into it.');
}

    
    
  function fillSelect(selectId){
  const sel = document.getElementById(selectId);
  if(!sel) return;
  sel.innerHTML = '';
  const list = (typeof manageableSections !== 'undefined' && Array.isArray(manageableSections))
    ? manageableSections
    : (window.manageableSections || []);
  list.forEach(s=>{
    const opt = document.createElement('option');
    opt.value = s.id;
    opt.textContent = s.label;
    sel.appendChild(opt);
  });
}
function showModal(id){
  const m = document.getElementById(id);
  if(m) m.style.display='flex';
}
function closeModal(id){
  const m = document.getElementById(id);
  if(m) m.style.display='none';

  // base list from manageableSections (default + any custom we stored)
  const list = (typeof manageableSections !== 'undefined' && Array.isArray(manageableSections))
    ? manageableSections
    : (window.manageableSections || []);

  // also include any sections currently present in the DOM (grids)
  const domSections = [...document.querySelectorAll('.grid[data-section]')]
    .map(g => ({ id: g.getAttribute('data-section'), label: (g.closest('.section')?.querySelector('h2')?.textContent || g.getAttribute('data-section')) }))
    .filter(s => s.id);

  // merge by id (preserve label from manageableSections if exists)
  const byId = new Map(list.map(s => [s.id, s]));
  domSections.forEach(s => { if (!byId.has(s.id)) byId.set(s.id, s); });

  [...byId.values()].forEach(s => {
    const opt = document.createElement('option');
    opt.value = s.id;
    opt.textContent = s.label;
    sel.appendChild(opt);
  });
}
    async function confirmRemove(){
      const sec = document.getElementById('removeSection').value;
      const sel = document.getElementById('removeButton');
      if (!sec || !sel.value) { alert('Pick a button to remove.'); return; }

      const rawLabel = sel.options[sel.selectedIndex].getAttribute('data-raw');
      const nLabel   = normLabel(rawLabel);

      const grid = sectionGrid(sec);
      if (!grid) { alert('Section not found.'); return; }

      [...grid.querySelectorAll('.btn')].forEach(b => {
        if (normLabel(b.textContent) === nLabel) b.remove();
      });

      const state = loadState();

      if (state.added[sec]) {
        state.added[sec] = state.added[sec].filter(x => normLabel(x.label) !== nLabel);
      }

      state.removed[sec] = state.removed[sec] || [];
      const already = new Set(state.removed[sec].map(l => normLabel(l)));
      if (!already.has(nLabel)) state.removed[sec].push(rawLabel);

      saveState(state);
      closeModal('removeModal');
      alert('Button removed.');

      const remote = await fetchRemoteConfig();
      const merged = mergeStates(state, remote);
      await syncRemote(merged);
    }
    window.addEventListener('DOMContentLoaded', init);
  </script>
<script>
if ('serviceWorker' in navigator) {
  window.addEventListener('load', async () => {
    try {
      const reg = await navigator.serviceWorker.register('./sw.v4.js');

      function showUpdatePrompt(waitingSW) {
        // Create a lightweight banner
        const bar = document.createElement('div');
        bar.style.cssText = 'position:fixed;left:0;right:0;bottom:0;padding:12px 16px;background:#111827;color:#fff;display:flex;gap:12px;align-items:center;justify-content:center;z-index:9999;border-top:1px solid rgba(148,163,184,.22)';
        bar.innerHTML = `
          <span>New update available.</span>
          <button id="a1vip-update" style="background:#22d3ee;border:none;color:#0b1220;font-weight:800;border-radius:10px;padding:8px 12px;cursor:pointer;">Update</button>
          <button id="a1vip-dismiss" style="background:transparent;border:1px solid rgba(148,163,184,.22);color:#e5e7eb;border-radius:10px;padding:8px 12px;cursor:pointer;">Later</button>
        `;
        document.body.appendChild(bar);

        document.getElementById('a1vip-dismiss').onclick = () => bar.remove();
        document.getElementById('a1vip-update').onclick = () => {
          waitingSW.postMessage({ type: 'SKIP_WAITING' });
        };

        // When controller changes, the new SW is active → reload to pick up fresh files
        navigator.serviceWorker.addEventListener('controllerchange', () => {
          // debounce to avoid double reloads
          setTimeout(() => window.location.reload(), 100);
        });
      }

      // If a new SW is already waiting (e.g., returning to the page)
      if (reg.waiting) showUpdatePrompt(reg.waiting);

      // Detect new SW installs while the page is open
      reg.addEventListener('updatefound', () => {
        const newSW = reg.installing;
        if (!newSW) return;
        newSW.addEventListener('statechange', () => {
          if (newSW.state === 'installed' && reg.waiting) {
            showUpdatePrompt(reg.waiting);
          }
        });
      });

      // Optional: check for updates on an interval (e.g., every 30 min)
      setInterval(() => reg.update().catch(()=>{}), 30 * 60 * 1000);
    } catch (e) {
      console.error('SW registration failed', e);
    }
  });
}
</script>
</body>
</html>
